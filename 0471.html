<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ultimate Calm Visualization Engine v2</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      height: 100vh;
      overflow: hidden;
      background: linear-gradient(135deg, #0a0e14, #1a2633);
      font-family: 'Segoe UI', sans-serif;
      color: #fff;
      transition: background 2s ease;
    }
    .container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    .message-box {
      position: absolute;
      font-size: clamp(1.5rem, 3.5vw, 4rem);
      color: rgba(255, 255, 255, 0.95);
      text-align: center;
      padding: 25px 50px;
      border-radius: 40px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(15px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      opacity: 0;
      transform: translateY(50px) scale(0.9);
      transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
      z-index: 10;
    }
    .message-box.active {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    .ui-overlay {
      position: absolute;
      z-index: 11;
      padding: 25px;
      top: 20px;
      left: 20px;
      opacity: 1;
      transition: opacity 0.5s ease;
    }
    .ui-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .control-panel {
      background: rgba(255, 255, 255, 0.08);
      padding: 20px;
      border-radius: 20px;
      backdrop-filter: blur(12px);
      display: flex;
      flex-direction: column;
      gap: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    button, select {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.12);
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }
    button:hover, select:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: scale(1.05);
    }
    #speedSlider {
      width: 100%;
      -webkit-appearance: none;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      outline: none;
      transition: background 0.3s;
    }
    #speedSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    #speedSlider:hover {
      background: rgba(255, 255, 255, 0.4);
    }
    #speedDisplay {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.85);
      text-align: center;
    }
    @media (max-width: 600px) {
      .control-panel { padding: 15px; }
      .message-box { font-size: 1.3rem; padding: 20px 40px; bottom: 70px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <canvas id="canvas"></canvas>
    <div class="message-box" id="messageBox"></div>
    <div class="ui-overlay" id="uiOverlay">
      <div class="control-panel">
        <button id="toggleAudio">Toggle Audio</button>
        <input type="range" id="speedSlider" min="1000" max="12000" value="6000" step="100">
        <div id="speedDisplay">Speed: 6.0s</div>
        <button id="fullscreen">Fullscreen</button>
        <button id="hideControls">Hide Controls</button>
        <select id="themeSelect">
          <option value="cosmic">Cosmic</option>
          <option value="ocean">Ocean</option>
          <option value="forest">Forest</option>
        </select>
      </div>
    </div>
  </div>

  <script>
    // ––– Canvas Setup –––
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;

    function resizeCanvas() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);

    // ––– Particles Class –––
    class Particles {
      constructor(count) {
        this.count = count;
        this.particles = [];
        for (let i = 0; i < count; i++) {
          this.particles.push({
            x: Math.random() * width,
            y: Math.random() * height,
            vx: (Math.random() - 0.5) * 1,
            vy: (Math.random() - 0.5) * 1,
            size: Math.random() * 4 + 3,
            angle: Math.random() * Math.PI * 2, // For cosmic orbits
            orbitRadius: Math.random() * 50 + 20, // For cosmic theme
            trail: Array(8).fill({ x: 0, y: 0 })
          });
        }
      }

      update(mouseX, mouseY, theme) {
        this.particles.forEach(p => {
          const dx = mouseX - p.x;
          const dy = mouseY - p.y;
          const dist = Math.sqrt(dx * dx + dy * dy) || 1;

          // Theme-specific behavior
          if (theme === 'cosmic') {
            p.angle += 0.02; // Orbiting motion
            p.vx = Math.cos(p.angle) * 0.5 + dx / dist * 0.04;
            p.vy = Math.sin(p.angle) * 0.5 + dy / dist * 0.04;
          } else if (theme === 'ocean') {
            p.vy += Math.sin(Date.now() * 0.002 + p.x * 0.02) * 0.03; // Wave flow
            p.vx += dx / dist * 0.02;
            p.vy += dy / dist * 0.02;
          } else if (theme === 'forest') {
            p.vx += Math.sin(p.y * 0.01 + Date.now() * 0.001) * 0.1; // Leaf sway
            p.vy += (Math.random() - 0.5) * 0.05 + dy / dist * 0.03;
          }

          p.x += p.vx;
          p.y += p.vy;

          if (p.x < 0 || p.x > width) p.vx *= -0.8;
          if (p.y < 0 || p.y > height) p.vy *= -0.8;

          // Update trail
          for (let i = p.trail.length - 1; i > 0; i--) {
            p.trail[i] = { ...p.trail[i - 1] };
          }
          p.trail[0] = { x: p.x, y: p.y };

          // Dampen velocity
          p.vx *= 0.98;
          p.vy *= 0.98;
        });

        // Connect nearby particles
        if (theme === 'cosmic') {
          for (let i = 0; i < this.particles.length; i++) {
            for (let j = i + 1; j < this.particles.length; j++) {
              const p1 = this.particles[i];
              const p2 = this.particles[j];
              const dx = p1.x - p2.x;
              const dy = p1.y - p2.y;
              const dist = Math.sqrt(dx * dx + dy * dy);
              if (dist < 100) {
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.strokeStyle = `rgba(255, 255, 255, ${1 - dist / 100})`;
                ctx.lineWidth = 0.5;
                ctx.stroke();
              }
            }
          }
        }
      }

      render(theme) {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)'; // Soft fade
        ctx.fillRect(0, 0, width, height);

        this.particles.forEach(p => {
          const gradient = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size * 3);
          let r, g, b, pulse = Math.sin(Date.now() * 0.003) * 0.1 + 0.9;

          if (theme === 'cosmic') {
            r = 120 + Math.random() * 135;
            g = 160 + Math.random() * 95;
            b = 220 + Math.random() * 35;
            gradient.addColorStop(0, `rgba(${r * pulse}, ${g * pulse}, ${b * pulse}, 1)`);
            gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
            ctx.beginPath();
            ctx.arc(p.x + Math.cos(p.angle) * p.orbitRadius, p.y + Math.sin(p.angle) * p.orbitRadius, p.size / 2, 0, Math.PI * 2);
            ctx.fillStyle = gradient;
            ctx.fill();
          } else if (theme === 'ocean') {
            r = 30 + Math.random() * 60;
            g = 90 + Math.random() * 90;
            b = 180 + Math.random() * 75;
            gradient.addColorStop(0, `rgba(${r * pulse}, ${g * pulse}, ${b * pulse}, 0.9)`);
            gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
            ctx.fillStyle = gradient;
            ctx.fill();
            // Ripple effect
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size * 2 + Math.sin(Date.now() * 0.005) * 5, 0, Math.PI * 2);
            ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, 0.2)`;
            ctx.lineWidth = 1;
            ctx.stroke();
          } else if (theme === 'forest') {
            r = 60 + Math.random() * 90;
            g = 150 + Math.random() * 105;
            b = 30 + Math.random() * 60;
            gradient.addColorStop(0, `rgba(${r * pulse}, ${g * pulse}, ${b * pulse}, 0.8)`);
            gradient.addColorStop(1, `rgba(${r}, ${g}, ${b}, 0)`);
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(Math.sin(Date.now() * 0.002 + p.x * 0.01) * 0.2);
            ctx.fillStyle = gradient;
            ctx.fillRect(-p.size, -p.size / 2, p.size * 2, p.size);
            ctx.restore();
          }

          // Enhanced trails
          ctx.beginPath();
          ctx.moveTo(p.trail[0].x, p.trail[0].y);
          for (let i = 1; i < p.trail.length; i++) {
            ctx.lineTo(p.trail[i].x, p.trail[i].y);
          }
          ctx.strokeStyle = `rgba(${r}, ${g}, ${b}, ${theme === 'ocean' ? 0.4 : 0.2})`;
          ctx.lineWidth = theme === 'ocean' ? 3 : 1.5;
          ctx.stroke();
        });
      }
    }

    const particles = new Particles(120);

    // ––– Audio Engine (Enhanced) –––
    let audioContext, noiseSource, gainNode;
    function initAudio(theme) {
      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const bufferSize = audioContext.sampleRate * 10;
          const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
          const noiseData = noiseBuffer.getChannelData(0);
          let lastOut = 0;
          for (let i = 0; i < bufferSize; i++) {
            const white = Math.random() * 2 - 1;
            noiseData[i] = (lastOut + (0.02 * white)) / 1.02;
            lastOut = noiseData[i];
            noiseData[i] *= 0.15;
          }

          noiseSource = audioContext.createBufferSource();
          noiseSource.buffer = noiseBuffer;
          noiseSource.loop = true;
          gainNode = audioContext.createGain();
          gainNode.gain.value = 0.12;

          noiseSource.connect(gainNode).connect(audioContext.destination);
          noiseSource.start();
        }

        if (theme === 'ocean') {
          fetch('https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-61905/zapsplat_nature_ocean_waves_gentle_lapping_001_61905.mp3')
            .then(response => response.arrayBuffer())
            .then(data => audioContext.decodeAudioData(data))
            .then(buffer => {
              const waveSource = audioContext.createBufferSource();
              waveSource.buffer = buffer;
              waveSource.loop = true;
              waveSource.connect(gainNode).connect(audioContext.destination);
              waveSource.start();
            });
        } else if (theme === 'forest') {
          fetch('https://www.zapsplat.com/wp-content/uploads/2015/sound-effects-77317/zapsplat_nature_forest_ambience_birds_wind_001_77317.mp3')
            .then(response => response.arrayBuffer())
            .then(data => audioContext.decodeAudioData(data))
            .then(buffer => {
              const windSource = audioContext.createBufferSource();
              windSource.buffer = buffer;
              windSource.loop = true;
              windSource.connect(gainNode).connect(audioContext.destination);
              windSource.start();
            });
        } else if (theme === 'cosmic') {
          const osc = audioContext.createOscillator();
          osc.type = 'sine';
          osc.frequency.value = 60 + Math.random() * 20;
          const oscGain = audioContext.createGain();
          oscGain.gain.value = 0.05;
          osc.connect(oscGain).connect(audioContext.destination);
          osc.start();
          setTimeout(() => osc.stop(), 30000); // Subtle hum
        }

        if (audioContext.state === 'suspended') audioContext.resume();
      } catch (err) {
        console.error('Audio initialization failed:', err);
      }
    }
    function toggleAudio() {
      try {
        if (audioContext?.state === 'running') {
          audioContext.suspend();
        } else {
          initAudio(currentTheme);
        }
      } catch (err) {
        console.error('Toggle audio failed:', err);
      }
    }

    // ––– Messages & UI –––
    const messages = [
      'Drift into the cosmic abyss, bro',
      'Feel the universe’s heartbeat, fam',
      'Waves of calm crash over you, dude',
      'Leaves whisper peace in your soul',
      'Orbit the zen void, my friend',
      'Infinite chill awaits—dive in',
      'The calm flows through you, homie',
      'Serenity’s calling—answer it',
      'Vibe with the eternal now',
      'You’re the calm in the storm, bro'
    ];
    let messageIndex = 0;
    const messageBox = document.getElementById('messageBox');
    let intervalSpeed = 6000;
    let currentTheme = 'cosmic';

    function showMessage() {
      messageBox.textContent = messages[messageIndex];
      messageBox.classList.add('active');
      messageBox.style.left = `${(width - messageBox.offsetWidth) / 2}px`;
      messageBox.style.top = `${height * 0.75}px`;
      setTimeout(() => messageBox.classList.remove('active'), 5000);
      messageIndex = (messageIndex + 1) % messages.length;
    }

    function adjustSpeed(speed) {
      intervalSpeed = speed;
      clearInterval(messageInterval);
      messageInterval = setInterval(showMessage, intervalSpeed);
      document.getElementById('speedDisplay').textContent = `Speed: ${(intervalSpeed / 1000).toFixed(1)}s`;
      localStorage.setItem('calmSettings', JSON.stringify({ speed: intervalSpeed, theme: currentTheme }));
    }

    let messageInterval = setInterval(showMessage, intervalSpeed);

    function changeTheme(theme) {
      currentTheme = theme;
      if (theme === 'ocean') {
        document.body.style.background = 'linear-gradient(135deg, #0a1e2d, #2e4a5b)';
        particles.render('ocean');
        initAudio('ocean');
      } else if (theme === 'forest') {
        document.body.style.background = 'linear-gradient(135deg, #1a2e1a, #3a4e3a)';
        particles.render('forest');
        initAudio('forest');
      } else {
        document.body.style.background = 'linear-gradient(135deg, #0a0e14, #1a2633)';
        particles.render('cosmic');
        initAudio('cosmic');
      }
    }

    function toggleControls() {
      const uiOverlay = document.getElementById('uiOverlay');
      uiOverlay.classList.toggle('hidden');
    }

    // ––– Mouse & Touch Interaction –––
    let mouseX = width / 2, mouseY = height / 2;
    document.addEventListener('mousemove', (e) => {
      mouseX = e.clientX;
      mouseY = e.clientY;
    });
    document.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      mouseX = touch.clientX;
      mouseY = touch.clientY;
    }, { passive: false });

    // ––– Animation Loop –––
    function animate() {
      particles.update(mouseX, mouseY, currentTheme);
      particles.render(currentTheme);
      requestAnimationFrame(animate);
    }
    animate();

    // ––– Load Saved Settings –––
    const savedSettings = JSON.parse(localStorage.getItem('calmSettings') || '{}');
    if (savedSettings.speed) {
      intervalSpeed = savedSettings.speed;
      adjustSpeed(intervalSpeed);
      document.getElementById('speedSlider').value = intervalSpeed;
    }
    if (savedSettings.theme) {
      changeTheme(savedSettings.theme);
      document.getElementById('themeSelect').value = savedSettings.theme;
    }

    // ––– Event Listeners –––
    document.getElementById('toggleAudio').addEventListener('click', toggleAudio);
    document.getElementById('speedSlider').addEventListener('input', (e) => adjustSpeed(parseInt(e.target.value)));
    document.getElementById('fullscreen').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => console.error('Fullscreen failed:', err));
      } else {
        document.exitFullscreen().catch(err => console.error('Exit fullscreen failed:', err));
      }
    });
    document.getElementById('hideControls').addEventListener('click', toggleControls);
    document.getElementById('themeSelect').addEventListener('change', (e) => changeTheme(e.target.value));

    document.body.addEventListener('click', () => initAudio(currentTheme), { once: true });
    document.body.addEventListener('touchstart', () => initAudio(currentTheme), { once: true });
  </script>
</body>
</html>