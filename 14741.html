<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Cycle Resonance Visualization (NFA)" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cycle Resonance Visualization</title>
  <style>
    :root {
      /* Base Theme Variables */
      --bg-color: #0f0f13;
      --text-color: #ffffff;
      --panel-bg: rgba(15, 15, 19, 0.85);
      --highlight: #2196F3;

      /* Color References */
      --limegreen-color: #32CD32;
      --skyblue-color: #87CEFA;
      --orange-color: #FFA500;
      --pink-color: #FF69B4;
      --gold-color: #FFD700;
      --blueviolet-color: rgba(138, 43, 226, 0.8);
      --orangered-color: rgba(255, 69, 0, 0.8);
      --turquoise-color: #40E0D0; /* Unique color for 55-day Cycle */
      --purple-color: #800080;    /* Unique color for 21-day Cycle */
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
    }

    body {
      margin: 0;
      overflow: hidden;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      transition: background 0.3s, color 0.3s;
    }

    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    #cycleCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      display: block;
      z-index: 1; /* Behind the logo container */
    }

    /* Controls Panel Styling */
    .controls {
      position: absolute;
      top: 20px;
      width: 90%;
      max-width: 800px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      background: var(--panel-bg);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 4;
      flex-wrap: wrap;
      gap: 10px;
    }

    .control-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    .controls button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
      min-width: 80px;
    }

    .controls button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.4);
    }

    /* Date Display Styling */
    .date-display {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.9);
      white-space: nowrap;
      text-align: center;
    }

    /* Logo Container Styling */
    .logo-container {
      position: relative;
      z-index: 3; /* Above the canvas and controls */
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      /* Removed margin-top to center the logo */
    }

    /* The main logo styling */
    #custom-logo {
      width: 40px;   /* Reduced size by 50% from 80px to 40px */
      height: 40px;  /* Ensure height matches width for a perfect circle */
      border-radius: 50%; /* Makes the image circular */
      transition: opacity 0.5s ease-in-out;
      opacity: 0;
      object-fit: cover;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3); /* Reduced shadow */
    }

    /* Show the image once it's loaded */
    #custom-logo.loaded {
      opacity: 1;
    }

    /* Emoji Styling */
    .emoji {
      position: absolute;
      top: -30px; /* Position above the logo */
      font-size: 24px;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }

    .emoji.active {
      opacity: 1;
      transform: translateY(-10px);
    }

    /* Specific Emojis */
    .emoji.fire {
      left: 50%;
      transform: translateX(-50%) translateY(0);
    }

    .emoji.boom {
      left: 60%;
      transform: translateX(-50%) translateY(0);
    }

    .emoji.beer {
      left: 40%;
      transform: translateX(-50%) translateY(0);
    }

    /* Legend Panel */
    .legend {
      position: absolute;
      bottom: 60px; /* Positioned below the visualization */
      width: 90%;
      max-width: 800px;
      font-size: 0.8rem;
      background: var(--panel-bg);
      padding: 0.75rem 1rem;
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
    }

    .legend h3 {
      display: none; /* Hidden as legend is now horizontal */
    }

    .legend ul {
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      gap: 15px;
      justify-content: center;
      width: 100%;
    }

    .legend li {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1 1 120px; /* Allows items to wrap nicely */
      justify-content: center;
    }

    .legend li span {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--highlight);
    }

    .legend li.follow-link span {
      background: var(--highlight); /* Highlight color for follow link */
    }

    .legend a {
      color: var(--highlight);
      text-decoration: none;
      transition: color 0.2s, transform 0.2s;
    }

    .legend a:hover {
      color: var(--skyblue-color);
      text-decoration: underline;
      transform: translateY(-1px);
    }

    /* Responsive Enhancements */
    @media (max-width: 1024px) {
      .legend {
        bottom: 50px;
      }
    }

    @media (max-width: 768px) {
      .controls {
        width: 95%;
        top: 10px;
      }

      .legend {
        bottom: 50px;
      }

      .logo-container #custom-logo {
        width: 35px;
        height: 35px;
      }

      .date-display {
        font-size: 0.85rem;
      }

      .emoji {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .controls {
        flex-direction: column;
        gap: 8px;
        align-items: center;
      }

      .control-buttons {
        flex-wrap: wrap;
        justify-content: center;
      }

      .controls button {
        min-width: 70px;
        padding: 6px 12px;
        font-size: 0.8rem;
      }

      .date-display {
        font-size: 0.8rem;
        margin-top: 8px;
      }

      .legend {
        bottom: 50px;
        padding: 0.5rem 0.75rem;
        gap: 10px;
      }

      .legend ul {
        gap: 10px;
      }

      .legend li {
        flex: 1 1 100px;
      }

      .logo-container #custom-logo {
        width: 30px;
        height: 30px;
      }

      .emoji {
        font-size: 18px;
      }
    }

    @media (max-width: 320px) {
      .controls button {
        min-width: 60px;
        padding: 5px 8px;
        font-size: 0.7rem;
      }

      .date-display {
        font-size: 0.7rem;
      }

      .legend li {
        flex: 1 1 80px;
      }

      .logo-container #custom-logo {
        width: 25px;
        height: 25px;
      }

      .emoji {
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Controls Panel -->
    <div class="controls panel" id="controls">
      <div class="control-buttons">
        <button id="pause-btn" aria-label="Pause Animation">Pause</button>
        <button id="reset-btn" aria-label="Reset Animation">Reset</button>
        <button id="speed-down-btn" aria-label="Decrease Speed">Slower</button>
        <button id="speed-up-btn" aria-label="Increase Speed">Faster</button>
      </div>
      <!-- Date Display Integrated into Controls -->
      <div class="date-display" id="date-display">
        Current: 01/28/2021
      </div>
    </div>

    <!-- Logo Container with Circular Image and Emojis -->
    <div class="logo-container">
      <a href="https://x.com/_D_741Stef" target="_blank" rel="noopener noreferrer">
        <img
          id="custom-logo"
          src="https://pbs.twimg.com/profile_images/1874116995991359488/olXssn9f_400x400.jpg"
          alt="Visit @_D_741Stef's X Profile"
          loading="lazy"
          onload="this.classList.add('loaded')"
        />
      </a>
      <!-- Emojis Positioned Over the Logo -->
      <span class="emoji fire">üî•</span>
      <span class="emoji boom">üí•</span>
      <span class="emoji beer">üçª</span>
    </div>

    <!-- Canvas for Visualization -->
    <canvas id="cycleCanvas"></canvas>

    <!-- Legend Panel with Follow Link -->
    <div class="legend panel" id="legend">
      <ul>
        <li><span style="background: var(--limegreen-color);"></span> Main ~4yrs Cycle</li>
        <li><span style="background: var(--blueviolet-color);"></span> 1470-day Cycle</li>
        <li><span style="background: var(--orangered-color);"></span> 1471-day Cycle</li>
        <li><span style="background: var(--gold-color);"></span> 741-day Cycle</li>
        <li><span style="background: var(--skyblue-color);"></span> 147-day Cycle</li>
        <li><span style="background: var(--turquoise-color);"></span> 55-day Cycle</li>
        <li><span style="background: var(--orange-color);"></span> 35-day Cycle</li>
        <li><span style="background: var(--purple-color);"></span> 21-day Cycle</li>
        <!-- Follow Link as a new list item -->
        <li class="follow-link">
          <span style="background: var(--highlight);"></span>
          <a href="https://x.com/_D_741Stef" target="_blank" rel="noopener noreferrer">
            Follow @_D_741Stef
          </a>
        </li>
      </ul>
    </div>
  </div>

  <script>
    /****************************************************
     * Cycle Resonance Visualization Script
     ****************************************************/
    const canvas = document.getElementById('cycleCanvas');
    const ctx = canvas.getContext('2d');

    const dateDisplayPanel = document.getElementById('date-display');
    const pauseBtn = document.getElementById('pause-btn');
    const resetBtn = document.getElementById('reset-btn');
    const speedDownBtn = document.getElementById('speed-down-btn');
    const speedUpBtn = document.getElementById('speed-up-btn');

    const fireEmoji = document.querySelector('.emoji.fire');
    const boomEmoji = document.querySelector('.emoji.boom');
    const beerEmoji = document.querySelector('.emoji.beer');

    let isPaused = false;
    let isScrubbing = false;
    let scrubStartX = 0;

    let lastTime = performance.now();
    let frameCount = 0;

    let speedMultiplier = 0.1;

    // Cycles Definition
    const CYCLES = [
      { name: 'Main ~4yrs (1461)', length: 1461, color: 'var(--limegreen-color)' },
      { name: '1470-day',         length: 1470, color: 'var(--blueviolet-color)' },
      { name: '1471-day',         length: 1471, color: 'var(--orangered-color)' },
      { name: '741-day',           length: 741,  color: 'var(--gold-color)'      },
      { name: '147-day',           length: 147,  color: 'var(--skyblue-color)'   },
      { name: '55-day',            length: 55,   color: 'var(--turquoise-color)' },
      { name: '35-day',            length: 35,   color: 'var(--orange-color)'    },
      { name: '21-day',            length: 21,   color: 'var(--purple-color)'    }
    ];

    // ‚ÄúCrucial‚Äù or interesting dates
    const START_DATE = new Date(2021, 0, 28);
    const CRUCIAL_DATES = [
      new Date(2025, 0, 9),
      new Date(2025, 0, 12),
      new Date(2025, 0, 23),
      new Date(2025, 0, 28),
      new Date(2024, 4, 1),
      new Date(2025, 0, 29), // Lunar New Year
      new Date(2024, 11, 25) // Christmas Gift Box Meme
    ];

    // Specific Emoji Dates
    const EMOJI_DATES = {
      "2025-01-27": "fire",
      "2025-01-28": "boom",
      "2025-01-29": "beer"
    };

    // Time in ‚Äúdays since START_DATE‚Äù
    let time = 0;

    // Resonances Data
    const resonances = [
      // Pairwise Resonances
      {
        name: "E & F (35-day & 21-day)",
        lcm: 105, // days
        dates: [
          new Date("2021-05-13"),
          new Date("2021-08-26"),
          new Date("2021-12-09"),
          new Date("2022-03-23"),
          new Date("2022-07-07"),
          new Date("2022-10-21"),
          new Date("2023-02-03"),
          new Date("2023-05-18"),
          new Date("2023-09-01"),
          new Date("2023-12-16"),
          new Date("2024-04-29"),
          new Date("2024-08-13"),
          new Date("2024-11-27"),
          new Date("2025-03-11")
        ]
      },
      {
        name: "D & E (55-day & 35-day)",
        lcm: 385,
        dates: [
          new Date("2022-02-17"),
          new Date("2023-02-17"),
          new Date("2024-02-17"),
          new Date("2025-02-16") // Adjusted for leap year
        ]
      },
      {
        name: "C & E (147-day & 35-day)",
        lcm: 735,
        dates: [
          new Date("2023-02-02"),
          new Date("2025-02-02")
        ]
      },
      {
        name: "D & F (55-day & 21-day)",
        lcm: 1155,
        dates: [
          new Date("2024-03-28")
        ]
      },
      
      // Triplet Resonances
      {
        name: "C, E & F (147-day, 35-day & 21-day)",
        lcm: 735,
        dates: [
          new Date("2023-02-02"),
          new Date("2025-02-02")
        ]
      },
      {
        name: "D, E & F (55-day, 35-day & 21-day)",
        lcm: 1155,
        dates: [
          new Date("2024-03-28")
        ]
      },

      // New 1470 and 1471-day cycles
      {
        name: "1470-Day Cycle Resonance",
        lcm: 1470,
        dates: [
          new Date("2025-01-27"), // 4 years minus 1 day from Jan 28, 2021
          new Date("2029-01-26")  // Next occurrence
        ]
      },
      {
        name: "1471-Day Cycle Resonance",
        lcm: 1471,
        dates: [
          new Date("2025-01-29"), // 4 years plus 1 day from Jan 28, 2021
          new Date("2029-01-28")  // Next occurrence
        ]
      }
    ];

    // Resonance Log (for debugging purposes)
    const resonanceLog = [];

    function logResonance(type, date, details) {
      resonanceLog.push({ type, date, details });
      console.log(`Resonance Triggered: ${type} on ${formatDate(date)} - ${details}`);
    }

    // Resize the canvas to fit the window
    function resizeCanvas() {
      // Get device pixel ratio for high-DPR devices
      const dpr = window.devicePixelRatio || 1;
      
      // Get the size of the canvas in CSS pixels
      const rect = canvas.getBoundingClientRect();
      
      // Set the canvas width and height based on DPR
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      
      // Clear any existing scaling
      ctx.setTransform(1, 0, 0, 1, 0, 0);
      
      // Scale the drawing context to account for DPR
      ctx.scale(dpr, dpr);
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Draw a single cycle ring + marker
    function drawCycleRing(x, y, radius, progress, cycleColor) {
      const angle = progress * 2 * Math.PI;
      // Outer circle
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = cycleColor;
      ctx.lineWidth = 2;
      ctx.stroke();

      // Marker dot -> white fill so visible
      const markerX = x + Math.cos(angle) * radius;
      const markerY = y + Math.sin(angle) * radius;
      ctx.beginPath();
      ctx.arc(markerX, markerY, 6, 0, 2 * Math.PI);
      ctx.fillStyle = '#fff'; 
      ctx.fill();
    }

    // Check and highlight resonances
    function checkResonance(x, y, radius, progressA, progressB, currentDate) {
      const alignmentThreshold = 0.02;
      const dayThreshold = 1; // days
      
      const diff = Math.abs(progressA - progressB);

      // Check for cycle alignment
      const isAlignment = diff < alignmentThreshold || Math.abs(1 - diff) < alignmentThreshold;

      // Check for proximity to crucial dates
      const nearCrucial = CRUCIAL_DATES.some(cd => {
        const dayDiff = Math.abs((currentDate - cd) / (1000 * 60 * 60 * 24));
        return dayDiff < dayThreshold;
      });

      // Determine resonance type
      if (isAlignment && nearCrucial) {
        // High significance: Both alignment and crucial date proximity
        ctx.beginPath();
        ctx.arc(x, y, radius * 1.3, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(255, 215, 0, 0.9)'; // Gold for high significance
        ctx.lineWidth = 4;
        ctx.stroke();
        
        // Log or display resonance
        logResonance("Alignment & Crucial Date", currentDate, "High significance resonance.");
      } else if (isAlignment) {
        // Medium significance: Cycle alignment
        ctx.beginPath();
        ctx.arc(x, y, radius * 1.2, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(0, 255, 0, 0.7)'; // Green for alignment
        ctx.lineWidth = 3;
        ctx.stroke();
        
        logResonance("Alignment", currentDate, "Cycle alignment resonance.");
      } 

      if (nearCrucial) {
        // Medium significance: Crucial date proximity
        ctx.beginPath();
        ctx.arc(x, y, radius * 1.1, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(255, 165, 0, 0.7)'; // Orange for date proximity
        ctx.lineWidth = 3;
        ctx.stroke();
        
        logResonance("Crucial Date Proximity", currentDate, "Near a crucial date resonance.");
      }
    }

    // Check for multiple resonances on the same date
    function checkMultiCycleResonance(x, y, currentDate) {
      let resonanceCount = 0;
      
      resonances.forEach(resonance => {
        resonance.dates.forEach(resDate => {
          const dayDiff = Math.abs((currentDate - resDate) / (1000 * 60 * 60 * 24));
          if (dayDiff < speedMultiplier) {
            resonanceCount++;
          }
        });
      });
      
      if (resonanceCount >= 2) {
        // High significance: Multiple resonances on the same date
        ctx.beginPath();
        ctx.arc(x, y, 150, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.9)'; // Red for multiple resonances
        ctx.lineWidth = 5;
        ctx.stroke();
        
        logResonance("Multiple Resonances", currentDate, `${resonanceCount} resonances on the same date.`);
      }
    }

    // Check for 35-day cycle resonance
    function checkThirtyFiveDayCycle(x, y, currentDate) {
      const startDate = new Date(2024, 11, 25); // December 25, 2024
      const targetDate = new Date(startDate.getTime() + 35 * 24 * 60 * 60 * 1000); // 35 days later

      const dayDiff = Math.abs((currentDate - targetDate) / (1000 * 60 * 60 * 24));

      if (dayDiff < speedMultiplier) { // Within threshold
        // Highlight the 35-day cycle resonance
        ctx.beginPath();
        ctx.arc(x, y, 120, 0, 2 * Math.PI); // Example: adjustable radius
        ctx.strokeStyle = 'rgba(138, 43, 226, 0.8)'; // BlueViolet for differentiation
        ctx.lineWidth = 4;
        ctx.stroke();

        // Label the resonance
        ctx.font = '16px Arial';
        ctx.fillStyle = 'rgba(138, 43, 226, 0.9)';
        ctx.fillText(`35-Day Cycle Resonance`, x + 130, y);
    
        // Log the resonance
        logResonance("35-Day Cycle", currentDate, "35 days post Christmas gift box meme.");
      }
    }

    // Check for 1470 and 1471-day cycles
    function check1470And1471Cycles(x, y, currentDate) {
      resonances.forEach(resonance => {
        resonance.dates.forEach(resDate => {
          const dayDiff = Math.abs((currentDate - resDate) / (1000 * 60 * 60 * 24));
          if (dayDiff < speedMultiplier) {
            // Draw a special marker or highlight
            ctx.beginPath();
            ctx.arc(x, y, 100, 0, 2 * Math.PI); // Example: a fixed radius circle
            ctx.strokeStyle = 'yellow';
            ctx.lineWidth = 4;
            ctx.stroke();

            // Optionally, display resonance name
            ctx.font = '16px Arial';
            ctx.fillStyle = 'yellow';
            ctx.fillText(resonance.name, x + 120, y);
          }
        });
      });

      // Specific Resonances for 1470 and 1471-day cycles
      const cycle1470 = new Date(START_DATE.getTime() + 1470 * 24 * 60 * 60 * 1000); // 1470 days after start
      const cycle1471 = new Date(START_DATE.getTime() + 1471 * 24 * 60 * 60 * 1000); // 1471 days after start

      const dayDiff1470 = Math.abs((currentDate - cycle1470) / (1000 * 60 * 60 * 24));
      const dayDiff1471 = Math.abs((currentDate - cycle1471) / (1000 * 60 * 60 * 24));

      if (dayDiff1470 < speedMultiplier) {
        // Draw a distinct marker for 1470-day cycle
        ctx.beginPath();
        ctx.arc(x, y, 130, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(138, 43, 226, 0.8)'; // BlueViolet
        ctx.lineWidth = 4;
        ctx.stroke();

        // Label the resonance
        ctx.font = '14px Arial';
        ctx.fillStyle = 'rgba(138, 43, 226, 0.9)';
        ctx.fillText(`1470-Day Cycle Resonance`, x + 140, y - 20);

        // Log the resonance
        logResonance("1470-Day Cycle", currentDate, "4 years minus 1 day cycle.");
      }

      if (dayDiff1471 < speedMultiplier) {
        // Draw a distinct marker for 1471-day cycle
        ctx.beginPath();
        ctx.arc(x, y, 140, 0, 2 * Math.PI);
        ctx.strokeStyle = 'rgba(255, 69, 0, 0.8)'; // OrangeRed
        ctx.lineWidth = 4;
        ctx.stroke();

        // Label the resonance
        ctx.font = '14px Arial';
        ctx.fillStyle = 'rgba(255, 69, 0, 0.9)';
        ctx.fillText(`1471-Day Cycle Resonance`, x + 150, y - 20);

        // Log the resonance
        logResonance("1471-Day Cycle", currentDate, "4 years plus 1 day cycle.");
      }
    }

    // Draw annotations like significant events or quotes
    function drawAnnotations(x, y) {
      const annotationDates = [
        new Date(2025, 0, 28), // January 28, 2025
        new Date(2025, 0, 29)  // January 29, 2025
      ];

      annotationDates.forEach(date => {
        const currentDate = new Date(START_DATE.getTime() + time * 24 * 60 * 60 * 1000);
        const dayDiff = Math.abs((currentDate - date) / (1000 * 60 * 60 * 24));

        if (dayDiff < speedMultiplier) {
          // Draw a star marker
          ctx.beginPath();
          ctx.moveTo(x, y - 100); // Adjust position as needed
          // Define star points
          ctx.lineTo(x + 10, y - 80);
          ctx.lineTo(x + 30, y - 80);
          ctx.lineTo(x + 15, y - 60);
          ctx.lineTo(x + 20, y - 40);
          ctx.lineTo(x, y - 50);
          ctx.lineTo(x - 20, y - 40);
          ctx.lineTo(x - 15, y - 60);
          ctx.lineTo(x - 30, y - 80);
          ctx.lineTo(x - 10, y - 80);
          ctx.closePath();
          ctx.fillStyle = 'rgba(255, 215, 0, 0.9)'; // Gold color
          ctx.fill();
          ctx.strokeStyle = 'rgba(255, 215, 0, 1)';
          ctx.lineWidth = 2;
          ctx.stroke();

          // Label the annotation
          ctx.font = '14px Arial';
          ctx.fillStyle = 'rgba(255, 215, 0, 1)';
          ctx.fillText(`Significant Event`, x + 35, y - 70);

          // Draw the Ozymandias quote near the marker
          ctx.font = '12px Arial';
          ctx.fillStyle = 'rgba(255, 215, 0, 1)';
          ctx.fillText(`"Look on My Works, Ye Mighty, and Despair"`, x - 150, y + 180);
        }
      });
    }

    // Highlighting Resonances on the Canvas
    function drawAllCycles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const rect = canvas.getBoundingClientRect();
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const ringSpacing = Math.min(rect.width, rect.height) / (2 * CYCLES.length);

      const currentDate = new Date(START_DATE.getTime() + time * 24 * 60 * 60 * 1000);

      // Compute cycle progress & draw each ring
      let cycleProgresses = [];
      CYCLES.forEach((cycle, idx) => {
        const progress = (time % cycle.length) / cycle.length;
        cycleProgresses.push(progress);

        const ringRadius = ringSpacing * (CYCLES.length - idx);
        drawCycleRing(centerX, centerY, ringRadius, progress, cycle.color);
      });

      // Check resonances for all pairs
      for (let i = 0; i < CYCLES.length; i++) {
        for (let j = i + 1; j < CYCLES.length; j++) {
          const ringRadius = ringSpacing * (CYCLES.length - i);
          checkResonance(centerX, centerY, ringRadius, cycleProgresses[i], cycleProgresses[j], currentDate);
        }
      }

      // Check for multiple resonances
      checkMultiCycleResonance(centerX, centerY, currentDate);

      // Check for 35-day cycle resonance
      checkThirtyFiveDayCycle(centerX, centerY, currentDate);

      // Check for 1470 and 1471-day cycles
      check1470And1471Cycles(centerX, centerY, currentDate);

      // Draw Annotations
      drawAnnotations(centerX, centerY);

      // Highlight Resonances from Resonances Data
      resonances.forEach(resonance => {
        resonance.dates.forEach(resDate => {
          // Check if currentDate is within +/- speedMultiplier days of resonance date
          const dayDiff = Math.abs((currentDate - resDate) / (1000 * 60 * 60 * 24));
          if (dayDiff < speedMultiplier) {
            // Draw a special marker or highlight
            ctx.beginPath();
            ctx.arc(centerX, centerY, 100, 0, 2 * Math.PI); // Example: a fixed radius circle
            ctx.strokeStyle = 'yellow';
            ctx.lineWidth = 4;
            ctx.stroke();

            // Optionally, display resonance name
            ctx.font = '16px Arial';
            ctx.fillStyle = 'yellow';
            ctx.fillText(resonance.name, centerX + 120, centerY);
          }
        });
      });

      // Update date display
      dateDisplayPanel.textContent = `Current: ${formatDate(currentDate)}`;

      // Update Emojis based on current date
      updateEmojis(currentDate);
    }

    // Update Emojis Visibility
    function updateEmojis(currentDate) {
      const year = currentDate.getFullYear();
      const month = String(currentDate.getMonth() + 1).padStart(2, '0');
      const day = String(currentDate.getDate()).padStart(2, '0');
      const formattedDate = `${year}-${month}-${day}`;

      // Hide all emojis initially
      fireEmoji.classList.remove('active');
      boomEmoji.classList.remove('active');
      beerEmoji.classList.remove('active');

      // Check if the current date matches any of the emoji dates
      if (EMOJI_DATES[formattedDate] === "fire") {
        fireEmoji.classList.add('active');
      }
      if (EMOJI_DATES[formattedDate] === "boom") {
        boomEmoji.classList.add('active');
      }
      if (EMOJI_DATES[formattedDate] === "beer") {
        beerEmoji.classList.add('active');
      }
    }

    // Main animation loop
    function animate() {
      drawAllCycles();

      frameCount++;
      const now = performance.now();
      if (now - lastTime >= 1000) {
        // Update FPS display if statsPanel is used
        // statsPanel.textContent = `FPS: ${frameCount}`;
        frameCount = 0;
        lastTime = now;
      }

      if (!isPaused && !isScrubbing) {
        time += speedMultiplier;
      }

      requestAnimationFrame(animate);
    }

    // Handle window resize with debouncing
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(onResize, 200);
    });

    function onResize() {
      // Resize canvas
      resizeCanvas();
    }

    // Touch-based scrubbing with Enhanced Sensitivity
    function onTouchStart(e) {
      isScrubbing = true;
      scrubStartX = e.touches[0].clientX;
    }

    function onTouchMove(e) {
      if (!isScrubbing) return;
      const currentX = e.touches[0].clientX;
      const deltaX = currentX - scrubStartX;
      const dayDelta = deltaX / 5; // Increased sensitivity for smaller screens
      time += dayDelta;
      scrubStartX = currentX;
    }

    function onTouchEnd() {
      isScrubbing = false;
    }

    // Button event handlers
    function togglePause() {
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? 'Play' : 'Pause';
    }

    function resetTime() {
      time = 0;
    }

    function speedDown() {
      speedMultiplier = Math.max(speedMultiplier / 2, 0.01);
    }

    function speedUp() {
      speedMultiplier = Math.min(speedMultiplier * 2, 16);
    }

    // Listeners
    canvas.addEventListener('touchstart', onTouchStart);
    canvas.addEventListener('touchmove', onTouchMove);
    canvas.addEventListener('touchend', onTouchEnd);

    pauseBtn.addEventListener('click', togglePause);
    resetBtn.addEventListener('click', resetTime);
    speedDownBtn.addEventListener('click', speedDown);
    speedUpBtn.addEventListener('click', speedUp);

    // Init
    resizeCanvas();
    animate();
  </script>
</body>
</html>