<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="GME Cycle Resonator -- Squeeze Mechanics & Temporal Harmonics" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="theme-color" content="#000000" />
  <title>GME Cycle Resonator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
/* ───────────────────────────────────────
   VARIABLES + RESET
─────────────────────────────────────── */
:root{
  --bg-color:#0b0b0b;
  --text-color:#fff;
  --panel-bg:rgba(11,11,11,.90);
  --highlight:#00ffcc;
  --secondary-highlight:#ff3399;
  --third-highlight:#ffaa00;
  --control-bg:rgba(26,26,26,.8);
  --control-border:rgba(255,255,255,.1);
  --control-hover:rgba(255,255,255,.2);
  --code-bg:#1d1f21;
  --code-text:#00ffcc;
  --active-indicator:rgba(0,255,204,.3);
  --shadow-highlight:rgba(0,255,204,.3);
  --shadow-dark:rgba(0,0,0,.5);
  --modal-bg:rgba(11,11,11,.95);
  --header-gradient:linear-gradient(90deg, rgba(0,255,204,.7), rgba(255,51,153,.7));
  --button-height:50px;
  --resonance-color:rgba(0,255,204,0.6);
  --resonance-glow:0 0 20px rgba(0,255,204,0.6);
}
html.light-theme{
  --bg-color:#1a1a1a;
  --panel-bg:rgba(26,26,26,.92);
  --control-border:rgba(255,255,255,.2);
  --control-bg:rgba(255,255,255,.15);
  --control-hover:rgba(255,255,255,.25);
  --modal-bg:rgba(26,26,26,.95);
}
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overscroll-behavior:none}
body{
  background:var(--bg-color);
  color:var(--text-color);
  font-family:'Inter',system-ui,sans-serif;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition:background .3s,color .3s;
  overflow-y:auto;
  font-size:16px;
  line-height:1.5;
}

/* ───────────────────────────────────────
   FLOATING CONTROLS
─────────────────────────────────────── */
.control-button {
  position: fixed;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--control-bg);
  border: 1px solid var(--control-border);
  color: var(--text-color);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 20px;
  cursor: pointer;
  z-index: 100;
  box-shadow: 0 2px 10px var(--shadow-dark);
  transition: all 0.3s;
}

.control-button:active {
  transform: scale(0.95);
}

.theme-toggle {
  top: 15px;
  right: 15px;
}

.help-button {
  top: 15px;
  left: 15px;
}

.toggle-legend {
  bottom: 15px;
  right: 15px;
}

.keyboard-shortcuts {
  position: fixed;
  left: 10px;
  top: 75px;
  background: var(--panel-bg);
  border-radius: 8px;
  padding: 10px;
  z-index: 100;
  font-size: 0.85rem;
  box-shadow: 0 2px 10px var(--shadow-dark);
  border: 1px solid rgba(0,255,204,.2);
  display: none;
  transform: translateY(-10px);
  opacity: 0;
  transition: all 0.3s;
  width: calc(100% - 20px);
  max-width: 250px;
}

.keyboard-shortcuts.show {
  display: block;
  transform: translateY(0);
  opacity: 1;
}

.keyboard-shortcuts table {
  border-spacing: 0;
  border-collapse: collapse;
  width: 100%;
}

.keyboard-shortcuts td {
  padding: 2px 6px;
}

.keyboard-shortcuts td:first-child {
  text-align: right;
  white-space: nowrap;
}

.keyboard-shortcuts .key {
  background: rgba(0,0,0,.3);
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  border: 1px solid var(--control-border);
  margin-right: 4px;
  display: inline-block;
}

/* ───────────────────────────────────────
   CANVAS
─────────────────────────────────────── */
#cycleCanvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
  touch-action: none;
  display: block;
}

/* ───────────────────────────────────────
   CONTROLS BAR - MINIMALIST
─────────────────────────────────────── */
.controls-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: var(--panel-bg);
  display: flex;
  align-items: center;
  justify-content: space-around;
  padding: 0 10px;
  z-index: 10;
  box-shadow: 0 -2px 10px var(--shadow-dark);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-top: 1px solid rgba(0,255,204,.2);
}

.control-group {
  display: flex;
  align-items: center;
  gap: 12px;
}

.button-control {
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--control-bg);
  border: 1px solid var(--control-border);
  color: var(--text-color);
  border-radius: 50%;
  font-size: 18px;
  cursor: pointer;
}

.button-control:active {
  transform: scale(0.95);
  background: var(--control-hover);
}

.date-display {
  font-size: 0.9rem;
  font-weight: 600;
  text-align: center;
  padding: 5px 10px;
  background: rgba(0,0,0,.3);
  border-radius: 6px;
  min-width: 120px;
}

.time-speed {
  background: var(--highlight);
  color: #000;
  font-weight: 600;
  padding: 5px 10px;
  border-radius: 8px;
  font-size: 0.9rem;
  text-align: center;
  min-width: 60px;
}

/* ───────────────────────────────────────
   POPUP SETTINGS PANEL
─────────────────────────────────────── */
.settings-panel {
  position: fixed;
  bottom: 70px;
  left: 50%;
  transform: translateX(-50%) translateY(100%);
  width: 90%;
  max-width: 350px;
  background: var(--panel-bg);
  border-radius: 12px;
  box-shadow: 0 5px 20px var(--shadow-dark);
  border: 1px solid rgba(0,255,204,.2);
  z-index: 50;
  opacity: 0;
  transition: transform 0.3s, opacity 0.3s;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  pointer-events: none;
}

.settings-panel.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
  pointer-events: auto;
}

.settings-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 15px;
  border-bottom: 1px solid rgba(0,255,204,.2);
}

.settings-title {
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--highlight);
}

.settings-close {
  font-size: 22px;
  background: none;
  border: none;
  color: var(--text-color);
  cursor: pointer;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.settings-content {
  padding: 15px;
}

.slider-control {
  margin-bottom: 15px;
}

.slider-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.slider-label {
  font-weight: 500;
  font-size: 0.95rem;
}

/* Toggle switch */
.toggle-wrapper {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 15px;
}

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 52px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,.4);
  transition: .4s;
  border-radius: 34px;
  border: 1px solid var(--control-border);
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 4px;
  bottom: 3px;
  background-color: white;
  transition: .4s;
  border-radius: 50%;
}

input:checked + .toggle-slider {
  background-color: var(--highlight);
}

input:checked + .toggle-slider:before {
  transform: translateX(26px);
}

.slider-value {
  font-size: 0.9rem;
  color: var(--highlight);
  font-weight: 500;
  min-width: 40px;
  text-align: right;
}

/* Range slider */
input[type="range"] {
  -webkit-appearance: none;
  height: 8px;
  width: 100%;
  border-radius: 5px;  
  background: rgba(0,0,0,.4);
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--highlight);
  cursor: pointer;
  border: 2px solid #fff;
}

input[type="range"]::-moz-range-thumb {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--highlight);
  cursor: pointer;
  border: 2px solid #fff;
}

/* ───────────────────────────────────────
   LOGO / EMOJI / TOOLTIP / NOTIF
─────────────────────────────────────── */
.logo-container {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%,-50%);
  z-index: 5;
  pointer-events: none;
  width: 70px;
  height: 70px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.logo-container img {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  object-fit: cover;
  box-shadow: 0 0 20px var(--shadow-dark);
  transition: all .5s;
}

.logo-container.resonating img {
  animation: pulse-logo 2s infinite ease-in-out;
  box-shadow: 0 0 30px var(--resonance-color);
}

@keyframes pulse-logo {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.emoji {
  position: absolute;
  top: -30px;
  font-size: 30px;
  opacity: 0;
  transition: opacity .3s,transform .5s;
  pointer-events: none;
  filter: drop-shadow(0 0 5px rgba(0,0,0,.5));
}

.emoji.active {
  opacity: 1;
  transform: translateY(-20px);
  animation: float 3s ease-in-out infinite;
}

@keyframes float {
  0%{transform:translateY(-20px)}
  50%{transform:translateY(-30px)}
  100%{transform:translateY(-20px)}
}

.tooltip {
  position: absolute;
  background: var(--panel-bg);
  color: var(--text-color);
  padding: 10px 16px;
  border-radius: 8px;
  font-size: .85rem;
  pointer-events: none;
  opacity: 0;
  transition: opacity .3s, transform .3s;
  z-index: 20;
  max-width: 280px;
  box-shadow: 0 3px 15px var(--shadow-dark);
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(5px);
  border: 1px solid rgba(0,255,204,.2);
  text-align: center;
  transform: translateY(10px);
}

.tooltip.show {
  opacity: 1;
  transform: translateY(0);
}

.notification {
  position: fixed;
  bottom: 75px;
  left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: var(--panel-bg);
  color: var(--text-color);
  padding: 12px 20px;
  border-radius: 8px;
  box-shadow: 0 4px 20px var(--shadow-dark);
  z-index: 100;
  max-width: 90%;
  width: 300px;
  text-align: center;
  opacity: 0;
  transition: transform .4s cubic-bezier(0.175, 0.885, 0.32, 1.275),opacity .4s;
  pointer-events: none;
  border: 1px solid rgba(0,255,204,.2);
  font-weight: 500;
}

.notification.show {
  opacity: 1;
  transform: translateX(-50%) translateY(0);
}

.notification.resonance {
  border-color: var(--highlight);
  box-shadow: var(--resonance-glow);
  background: rgba(0,255,204,0.15);
}

/* ───────────────────────────────────────
   SCRUBBING INDICATOR
─────────────────────────────────────── */
.scrub-indicator {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0,255,204,0.15);
  border: 2px solid var(--highlight);
  border-radius: 50%;
  width: 80px;
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
  z-index: 50;
  box-shadow: var(--resonance-glow);
}

.scrub-indicator.active {
  opacity: 1;
}

.scrub-direction {
  font-size: 40px;
  font-weight: bold;
  color: var(--highlight);
  text-shadow: 0 0 8px rgba(0,255,204,0.8);
}

.scrub-ghost {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 5;
  opacity: 0;
  transition: opacity 0.2s;
}

.scrub-ghost.forward {
  background: linear-gradient(to left, rgba(0,255,204,0.1), transparent 40%);
  opacity: 1;
}

.scrub-ghost.backward {
  background: linear-gradient(to right, rgba(0,255,204,0.1), transparent 40%);
  opacity: 1;
}

.loading {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: var(--bg-color);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: opacity .5s;
}

.loading.done {
  opacity: 0;
  pointer-events: none;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  position: relative;
  margin-bottom: 30px;
}

.loading-spinner::before,
.loading-spinner::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 50%;
  background: linear-gradient(to right, var(--highlight), var(--secondary-highlight));
  animation: pulse-ring 2s linear infinite;
}

.loading-spinner::after {
  animation-delay: -1s;
}

@keyframes pulse-ring {
  0%{transform:scale(0.5);opacity:1}
  100%{transform:scale(1.5);opacity:0}
}

.loading-text {
  font-size: 1.3rem;
  font-weight: 600;
  text-shadow: 0 2px 10px rgba(0,0,0,0.5);
  margin-bottom: 5px;
}

.loading-subtext {
  font-size: 0.9rem;
  opacity: 0.7;
  max-width: 85%;
  text-align: center;
  padding: 0 15px;
}

.loading-progress {
  width: 80%;
  max-width: 250px;
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  margin-top: 20px;
  overflow: hidden;
}

.loading-progress-bar {
  height: 100%;
  width: 0%;
  background: var(--highlight);
  border-radius: 2px;
  transition: width 0.3s;
}

/* ───────────────────────────────────────
   LEGEND
─────────────────────────────────────── */
.legend {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 60px;
  padding: 10px;
  background: var(--panel-bg);
  border-radius: 15px 15px 0 0;
  z-index: 9;
  transform: translateY(100%);
  transition: transform 0.3s ease;
  border-top: 1px solid rgba(0,255,204,.2);
  box-shadow: 0 -2px 15px var(--shadow-dark);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.legend.open {
  transform: translateY(0);
}

.legend-header {
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 1rem;
  color: var(--highlight);
  text-align: center;
  height: 40px;
  width: 100%;
  position: relative;
  cursor: pointer;
}

.legend-content {
  margin-top: 5px;
}

.legend-indicator {
  font-size: .95rem;
  color: var(--highlight);
  min-height: 1.2em;
  padding: 8px 12px;
  background: rgba(0,0,0,.2);
  border-radius: 6px;
  width: 100%;
  text-align: center;
  transition: all .3s;
  font-weight: 500;
  margin-bottom: 10px;
}

.legend-indicator.active {
  color: #fff;
  background: var(--active-indicator);
  transform: scale(1.02);
  box-shadow: 0 2px 8px var(--shadow-highlight);
  animation: pulse-indicator 2s infinite;
}

@keyframes pulse-indicator {
  0%, 100% { background: var(--active-indicator); }
  50% { background: rgba(0,255,204,0.5); }
}

.cycle-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
  padding-bottom: 5px;
}

.cycle-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 10px 8px;
  border-radius: 8px;
  background: rgba(0,0,0,.2);
  transition: all .2s;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.85rem;
}

.cycle-item:active {
  transform: scale(0.98);
  background: rgba(255,255,255,.1);
}

.cycle-item.resonating {
  background: rgba(0,255,204,0.15);
  box-shadow: 0 0 10px rgba(0,255,204,0.4);
}

.cycle-dot {
  min-width: 12px;
  min-height: 12px;
  border-radius: 50%;
  box-shadow: 0 0 4px rgba(0,0,0,.3);
  transition: transform .3s;
  flex-shrink: 0;
}

.cycle-item:active .cycle-dot {
  transform: scale(1.5);
}

.cycle-dot.vibrate {
  animation: pulse-dot 0.8s infinite;
}

@keyframes pulse-dot {
  0%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,255,204,.7)}
  70%{transform:scale(1.4);box-shadow:0 0 0 8px rgba(0,255,204,0)}
  100%{transform:scale(1);box-shadow:0 0 0 0 rgba(0,255,204,0)}
}

/* ───────────────────────────────────────
   MODAL PANEL
─────────────────────────────────────── */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0);
  display: none;
  opacity: 0;
  transition: opacity .3s;
  z-index: 900;
}

.modal-overlay.show {
  display: block;
  opacity: 1;
  background: rgba(0,0,0,.5);
  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px);
}

.modal-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 80%;
  max-height: 80vh;
  transform: translateY(100%);
  background: var(--modal-bg);
  border-radius: 20px 20px 0 0;
  border-top: 1px solid rgba(0,255,204,.2);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 -4px 30px var(--shadow-dark);
  z-index: 950;
  opacity: 0;
  pointer-events: none;
  overflow-y: auto;
  overflow-x: hidden;
  transition: transform .4s cubic-bezier(0.165, 0.84, 0.44, 1),opacity .3s;
}

.modal-panel.show {
  transform: translateY(0);
  opacity: 1;
  pointer-events: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid rgba(0,255,204,.2);
  background: rgba(0,0,0,.2);
  position: sticky;
  top: 0;
  z-index: 20;
}

.modal-title {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--highlight);
  text-shadow: 0 2px 8px rgba(0,255,204,.3);
}

.modal-close {
  background: rgba(0,0,0,.3);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 50%;
  color: #fff;
  font-size: 24px;
  cursor: pointer;
  opacity: .9;
  transition: all .2s;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 10px;
}

.modal-close:active {
  background: rgba(255,255,255,.2);
  transform: scale(0.95);
}

.modal-tabs {
  display: flex;
  border-bottom: 1px solid rgba(0,255,204,.2);
  background: rgba(0,0,0,.15);
  position: sticky;
  top: 73px;
  z-index: 15;
}

.modal-tab {
  padding: 14px 0;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all .3s;
  color: #aaa;
  font-size: .9rem;
  font-weight: 500;
  flex: 1;
  text-align: center;
}

.modal-tab:hover {
  color: #fff;
  background: rgba(255,255,255,.05);
}

.modal-tab.active {
  color: var(--highlight);
  border-bottom-color: var(--highlight);
}

.modal-content {
  padding: 15px;
}

.tab-content {
  display: none;
  opacity: 0;
  transform: translateY(10px);
  transition: opacity .4s, transform .4s;
}

.tab-content.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
}

.modal-section {
  margin-bottom: 20px;
}

.modal-section-title {
  font-weight: 600;
  font-size: 1.05rem;
  color: var(--highlight);
  margin-bottom: 12px;
  padding-bottom: 4px;
  border-bottom: 1px solid rgba(0,255,204,.2);
}

.modal-section p {
  margin-bottom: 16px;
  line-height: 1.6;
}

.modal-section p:last-child {
  margin-bottom: 0;
}

.modal-section ul {
  margin-left: 20px;
  margin-bottom: 16px;
}

.modal-section li {
  margin-bottom: 8px;
  line-height: 1.5;
}

.modal-section li:last-child {
  margin-bottom: 0;
}

.modal-section li strong {
  color: var(--highlight);
}

/* Options strategy styles */
.cycle-strategy-card {
  background: rgba(0,0,0,.2);
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
  border-left: 3px solid var(--highlight);
  transition: all .3s;
  box-shadow: 0 2px 10px rgba(0,0,0,.2);
}

.cycle-title {
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--highlight);
  margin-bottom: 12px;
}

.strategy-section {
  margin-bottom: 12px;
}

.strategy-section:last-child {
  margin-bottom: 0;
}

.section-title {
  font-weight: 600;
  font-size: 1rem;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
}

.section-title::before {
  content: '';
  display: inline-block;
  width: 6px;
  height: 6px;
  background: var(--third-highlight);
  border-radius: 50%;
  margin-right: 8px;
  flex-shrink: 0;
}

.strategy-list {
  list-style-type: none;
  padding-left: 8px;
}

.strategy-list li {
  position: relative;
  padding-left: 18px;
  margin-bottom: 8px;
  font-size: .9rem;
  line-height: 1.5;
}

.strategy-list li::before {
  content: "▸";
  position: absolute;
  left: 0;
  color: var(--secondary-highlight);
  font-weight: bold;
}

/* Code block styling */
.code-block {
  background: var(--code-bg);
  padding: 12px;
  border-radius: 8px;
  font-family: 'JetBrains Mono',monospace;
  font-size: .8rem;
  color: var(--code-text);
  overflow-x: auto;
  line-height: 1.5;
  white-space: pre;
  box-shadow: inset 0 0 10px rgba(0,0,0,.4);
  border: 1px solid rgba(0,255,204,.1);
  margin-top: 10px;
  margin-bottom: 10px;
  max-width: 100%;
}

.script-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
  justify-content: center;
}

.script-btn {
  font-size: .85rem;
  padding: 12px 16px;
  background: var(--control-bg);
  border: 1px solid var(--control-border);
  border-radius: 8px;
  color: var(--text-color);
  cursor: pointer;
  transition: all .3s;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 500;
  width: 100%;
}

.script-btn::before {
  content: '📋';
  margin-right: 6px;
}

.script-btn:active {
  transform: scale(0.98);
  background: var(--control-hover);
}
  </style>
</head>

<body>
  <!-- FLOATING CONTROL BUTTONS -->
  <button class="control-button theme-toggle" id="theme-toggle" title="Toggle light/dark theme">🌓</button>
  <button class="control-button help-button" id="help-button" title="Help">?</button>
  <button class="control-button toggle-legend" id="toggle-legend" title="Toggle legend">🔍</button>
  
  <div class="keyboard-shortcuts" id="keyboard-shortcuts">
    <table>
      <tr><td><span class="key">Space</span></td><td>Pause/Play</td></tr>
      <tr><td><span class="key">R</span></td><td>Reset</td></tr>
      <tr><td><span class="key">←/→</span></td><td>Scrub time</td></tr>
      <tr><td><span class="key">↑</span></td><td>Speed up</td></tr>
      <tr><td><span class="key">↓</span></td><td>Slow down</td></tr>
      <tr><td><span class="key">I</span></td><td>Info panel</td></tr>
      <tr><td><span class="key">O</span></td><td>Options</td></tr>
      <tr><td><span class="key">T</span></td><td>Toggle theme</td></tr>
      <tr><td><span class="key">Esc</span></td><td>Close panels</td></tr>
    </table>
  </div>
  
  <!-- SCRUBBING INDICATORS -->
  <div class="scrub-indicator" id="scrub-indicator">
    <div class="scrub-direction" id="scrub-direction"></div>
  </div>
  <div class="scrub-ghost" id="scrub-ghost"></div>
  
  <!-- MAIN CONTAINER -->
  <main id="container">
    <!-- LOADING -->
    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <div class="loading-text">Initializing GME Cycle Resonator</div>
      <div class="loading-subtext">Loading visualization system...</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loading-progress-bar"></div>
      </div>
    </div>

    <!-- CANVAS -->
    <canvas id="cycleCanvas"></canvas>
    
    <!-- SIMPLIFIED CONTROLS BAR -->
    <div class="controls-bar" id="controls-bar">
      <div class="control-group">
        <button class="button-control" id="pause-btn" title="Pause/resume">⏯️</button>
        <button class="button-control" id="reset-btn" title="Reset">🔄</button>
      </div>
      
      <div class="date-display" id="date-display">...</div>
      
      <div class="control-group">
        <button class="button-control" id="speed-down-btn" title="Slower">⏪</button>
        <div class="time-speed" id="time-speed">0.05x</div>
        <button class="button-control" id="speed-up-btn" title="Faster">⏩</button>
      </div>
      
      <div class="control-group">
        <button class="button-control" id="settings-btn" title="Settings">⚙️</button>
        <button class="button-control" id="info-btn" title="Info">ℹ️</button>
      </div>
    </div>
    
    <!-- SETTINGS POPUP -->
    <div class="settings-panel" id="settings-panel">
      <div class="settings-header">
        <div class="settings-title">Settings</div>
        <button class="settings-close" id="settings-close">&times;</button>
      </div>
      
      <div class="settings-content">
        <div class="toggle-wrapper">
          <span class="slider-label">Mute Sound</span>
          <label class="toggle-switch">
            <input type="checkbox" id="muteSound">
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <div class="slider-control">
          <div class="slider-header">
            <span class="slider-label">Harmonic</span>
            <span class="slider-value" id="harmonic-value">1.00</span>
          </div>
          <input type="range" id="harmonicSlider" min="0.5" max="2" step="0.01" value="1">
        </div>
        
        <div class="slider-control">
          <div class="slider-header">
            <span class="slider-label">Resonance Sensitivity</span>
            <span class="slider-value" id="sensitivity-value">1.00</span>
          </div>
          <input type="range" id="sensitivitySlider" min="0.5" max="2" step="0.01" value="1">
        </div>
        
        <div class="slider-control">
          <div class="slider-header">
            <span class="slider-label">Timeline</span>
          </div>
          <input type="range" id="time-scrub" min="0" max="5000" step="1" value="0">
        </div>
      </div>
    </div>

    <!-- LOGO & EMOJI -->
    <div class="logo-container" id="logo-container">
      <img id="custom-logo" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAwIiBmaWxsPSJub25lIj48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjkwIiBmaWxsPSIjMDAwIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iNiIgLz48cGF0aCBkPSJNNTAgMTAwaDEwME0xMDAgNTB2MTAwIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iNCIgLz48Y2lyY2xlIGN4PSIxMDAiIGN5PSIxMDAiIHI9IjI1IiBmaWxsPSIjMDAwIiBzdHJva2U9IiMwMGZmY2MiIHN0cm9rZS13aWR0aD0iNCIgLz48cGF0aCBkPSJNNjAgMTQwbDgwLTgwTTE0MCA2MEw2MCAxNDAiIHN0cm9rZT0iI2ZmMzM5OSIgc3Ryb2tlLXdpZHRoPSIzIiAvPjxjaXJjbGUgY3g9IjEwMCIgY3k9IjEwMCIgcj0iNzAiIHN0cm9rZT0iI2ZmMzM5OSIgc3Ryb2tlLXdpZHRoPSIzIiBzdHJva2UtZGFzaGFycmF5PSI1IDUiIC8+PC9zdmc+" alt="GME Logo" class="glow">
      <span class="emoji fire">🚀</span>
      <span class="emoji boom">💎</span>
      <span class="emoji beer">🦍</span>
    </div>

    <!-- TOOLTIP & NOTIFICATION -->
    <div class="tooltip" id="tooltip"></div>
    <div class="notification" id="notification"></div>

    <!-- LEGEND -->
    <div class="legend" id="legend">
      <div class="legend-header" id="legend-header">🧿 GameStop Resonance Cycles</div>
      <div class="legend-content">
        <div class="legend-indicator" id="resonance-indicator">Resonance: Off</div>
        <div class="cycle-grid">
          <div class="cycle-item" id="legend-1461" data-cycle="1461">
            <span class="cycle-dot" style="background:hsl(0,100%,40%)"></span>
            1461: Accumulation
          </div>
          <div class="cycle-item" id="legend-741" data-cycle="741">
            <span class="cycle-dot" style="background:hsl(60,100%,40%)"></span>
            741: Short Squeeze
          </div>
          <div class="cycle-item" id="legend-55" data-cycle="55">
            <span class="cycle-dot" style="background:hsl(30,100%,40%)"></span>
            55: FOMO Swing
          </div>
          <div class="cycle-item" id="legend-35" data-cycle="35">
            <span class="cycle-dot" style="background:hsl(0,100%,40%)"></span>
            35: Momentum
          </div>
          <div class="cycle-item" id="legend-21" data-cycle="21">
            <span class="cycle-dot" style="background:hsl(60,100%,40%)"></span>
            21: Intraday
          </div>
          <div class="cycle-item" id="legend-999" data-cycle="999">
            <span class="cycle-dot" style="background:hsl(330,100%,40%)"></span>
            999: Tesla Loop
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL PANEL -->
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-panel" id="main-modal">
      <div class="modal-header">
        <div class="modal-title" id="modal-title">GME Cycle Information</div>
        <button class="modal-close" id="modal-close" aria-label="Close panel" title="Close panel">&times;</button>
      </div>
      <div class="modal-tabs">
        <div class="modal-tab active" data-tab="info-tab">Info</div>
        <div class="modal-tab" data-tab="options-tab">Options</div>
        <div class="modal-tab" data-tab="api-tab">API</div>
      </div>
      <div class="modal-content">
        <!-- Info Tab -->
        <div class="tab-content active" id="info-tab">
          <p>The GME Cycle Resonator visualizes key temporal mechanics that drive GameStop's unique market behavior. This tool renders multiple overlapping cycles to identify potential resonances and squeeze mechanics.</p>
          
          <div class="modal-section">
            <div class="modal-section-title">Key Cycle Mechanics:</div>
            <ul>
              <li><strong>1461: Institutional Accumulation</strong> - Matches U.S. presidential cycle. Mirrors long-game ETF rebalancing.</li>
              <li><strong>741: Short Squeeze Trigger</strong> - Institutional unwind window (741/999 = 0.741741… echoing infinity).</li>
              <li><strong>35: Momentum Surge</strong> - Heart of the FTD force-buy engine (T+35 settlement mechanics).</li>
              <li><strong>999: The Tesla Loop</strong> - 999 days from GameStonk tweet → Feb 18, 2025. Vortex math alignment.</li>
            </ul>
          </div>
          
          <div class="modal-section">
            <div class="modal-section-title">Controls:</div>
            <ul>
              <li><strong>⏯️</strong> - Pause/Play</li>
              <li><strong>🔄</strong> - Reset timeline</li>
              <li><strong>⏪/⏩</strong> - Slow down/Speed up</li>
              <li><strong>Swipe</strong> - Scrub timeline left/right</li>
              <li><strong>⚙️</strong> - Settings</li>
            </ul>
          </div>
          
          <p>Watch for special alignments between key cycles. The most powerful signals occur when multiple resonances stack at once!</p>
        </div>

        <!-- Options Strategy Tab -->
        <div class="tab-content" id="options-tab">
          <div class="cycle-strategy-card">
            <div class="cycle-title">55: FOMO Swing (Retail Lightning Loop)</div>
            <div class="strategy-section">
              <div class="section-title">Ideal Trades:</div>
              <ul class="strategy-list">
                <li>Short-dated OTM calls (2-4 weeks to expiry)</li>
                <li>Gamma ramp scalps</li>
                <li>0DTE meme catalysts with IV pops</li>
              </ul>
            </div>
          </div>
          
          <div class="cycle-strategy-card">
            <div class="cycle-title">35: Momentum Surge (T+35 Settlement Pulse)</div>
            <div class="strategy-section">
              <div class="section-title">Ideal Trades:</div>
              <ul class="strategy-list">
                <li>Calendar spreads targeting T+35 expiry</li>
                <li>Deep ITM calls to force-deliver shares</li>
                <li>Roll-up strategies anticipating FTD covers</li>
              </ul>
            </div>
          </div>

          <div class="cycle-strategy-card">
            <div class="cycle-title">741: Short Squeeze Trigger (The Infinity Echo)</div>
            <div class="strategy-section">
              <div class="section-title">Ideal Trades:</div>
              <ul class="strategy-list">
                <li>Long-dated synthetic LEAPs</li>
                <li>Straddle into volatility triggers</li>
                <li>Swoop-in post-puke accumulation</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- API Tab -->
        <div class="tab-content" id="api-tab">
          <div class="modal-section">
            <div class="modal-section-title">TradingView PineScript Overlay</div>
            <p>Copy this code to add GME cycle indicators to your TradingView chart:</p>
            <div class="code-block">//@version=5
indicator("🧿 GME Cycle", overlay=true)

startDate = input.time(timestamp("2020-08-01"), "Start Point")

cycleLengths = array.fromlist([55, 35, 147, 741, 999])
cycleNames = array.fromlist(["FOMO", "Surge", "Gamma", "Echo", "Tesla"])
colors = array.fromlist([color.new(color.orange, 70), color.new(color.red, 70), color.new(color.blue, 70), color.new(color.green, 70), color.new(color.purple, 70)])

for i = 0 to array.size(cycleLengths) - 1
    cl = array.get(cycleLengths, i)
    cyc = startDate + cl * 86400
    line.new(x1=cyc, y1=low - 10, x2=cyc, y2=high + 10, color=array.get(colors, i), width=2)
    label.new(x=cyc, y=high, text=array.get(cycleNames, i), style=label.style_label_left, color=array.get(colors, i), size=size.small)</div>
            <div class="script-actions">
              <button class="script-btn" id="copy-pinescript">Copy PineScript</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    /******************************************
     * MINIMAL CORE INITIALIZATION
    ******************************************/
    // Simple loading sequence with timeout protection
    let loadingTimeout;
    function startLoading() {
      const bar = document.getElementById('loading-progress-bar');
      let progress = 0;
      const interval = setInterval(() => {
        progress += 5;
        if (progress >= 100) {
          progress = 100;
          clearInterval(interval);
          window.isLoadingComplete = true;
        }
        bar.style.width = `${progress}%`;
      }, 50);
      
      // Safety timeout - force completion after 3 seconds
      loadingTimeout = setTimeout(() => {
        if (!window.isLoadingComplete) {
          console.log("Loading timeout triggered");
          document.getElementById('loading').classList.add('done');
          window.isLoadingComplete = true;
        }
      }, 3000);
    }
    
    // Start loading animation immediately
    startLoading();
    
    /******************************************
     * SETTINGS MANAGEMENT - SIMPLIFIED
    ******************************************/
    const DEFAULT_SETTINGS = {
      lightTheme: false,
      harmonicFactor: 1.0,
      resonanceSensitivity: 1.0,
      muteSound: false,
      legendOpen: false
    };
    
    let settings = DEFAULT_SETTINGS;
    
    function loadSettings() {
      try {
        const saved = localStorage.getItem("gmeResonatorSettings");
        return saved ? {...DEFAULT_SETTINGS, ...JSON.parse(saved)} : DEFAULT_SETTINGS;
      } catch (e) {
        console.log("Using default settings");
        return DEFAULT_SETTINGS;
      }
    }
    
    function saveSettings() {
      try {
        settings.harmonicFactor = parseFloat(document.getElementById('harmonicSlider').value);
        settings.resonanceSensitivity = parseFloat(document.getElementById('sensitivitySlider').value);
        settings.muteSound = document.getElementById('muteSound').checked;
        settings.legendOpen = document.getElementById('legend').classList.contains('open');
        localStorage.setItem("gmeResonatorSettings", JSON.stringify(settings));
      } catch (e) {
        console.log("Settings save error:", e);
      }
    }
    
    /******************************************
     * IMPROVED SOUND SYSTEM
    ******************************************/
    const SoundManager = {
      context: null,
      muted: false,
      initialized: false,
      soundQueue: [],
      
      init() {
        if (this.initialized) return true;
        
        try {
          const AudioContext = window.AudioContext || window.webkitAudioContext;
          if (!AudioContext) {
            console.log("Web Audio API not supported");
            return false;
          }
          
          this.context = new AudioContext();
          this.initialized = true;
          
          // Process any queued sounds
          this.processQueue();
          
          return true;
        } catch (e) {
          console.error("Audio initialization error:", e);
          return false;
        }
      },
      
      // Method to be called on user interaction
      unlock() {
        if (!this.initialized) {
          this.init();
        }
        
        if (this.context && this.context.state === 'suspended') {
          this.context.resume();
        }
      },
      
      playTone(frequency, duration = 0.2, type = 'sine', volume = 0.3) {
        // If not initialized or muted, don't play
        if (settings.muteSound) return;
        
        // If not initialized, queue the sound for later
        if (!this.initialized) {
          this.soundQueue.push({ frequency, duration, type, volume });
          return;
        }
        
        try {
          // Create oscillator
          const oscillator = this.context.createOscillator();
          oscillator.type = type;
          oscillator.frequency.value = frequency;
          
          // Create gain node
          const gainNode = this.context.createGain();
          gainNode.gain.value = volume;
          
          // Connect nodes
          oscillator.connect(gainNode);
          gainNode.connect(this.context.destination);
          
          // Start and stop the sound
          const now = this.context.currentTime;
          oscillator.start(now);
          oscillator.stop(now + duration);
          
          // Release reference
          oscillator.onended = () => {
            oscillator.disconnect();
            gainNode.disconnect();
          };
        } catch (e) {
          console.error("Error playing tone:", e);
        }
      },
      
      // Play a resonance chord
      playResonance() {
        if (settings.muteSound) return;
        
        this.playTone(261.63, 0.4, 'sine', 0.15); // C4
        setTimeout(() => this.playTone(329.63, 0.4, 'sine', 0.15), 150); // E4
        setTimeout(() => this.playTone(392.00, 0.4, 'sine', 0.15), 300); // G4
        setTimeout(() => this.playTone(523.25, 0.3, 'sine', 0.15), 450); // C5
      },
      
      // Process any sounds that were queued before initialization
      processQueue() {
        if (!this.initialized || this.soundQueue.length === 0) return;
        
        // Process each queued sound
        while (this.soundQueue.length > 0) {
          const sound = this.soundQueue.shift();
          this.playTone(sound.frequency, sound.duration, sound.type, sound.volume);
        }
      },
      
      // Set mute state
      setMute(muted) {
        this.muted = muted;
      }
    };
    
    /******************************************
     * TIMELINE SCRUBBING CONTROLS
    ******************************************/
    const TimelineScrubber = {
      isDragging: false,
      startX: 0,
      lastX: 0,
      sensitivity: 0.5, // Default sensitivity
      scrubSpeed: 1,
      minScrubSpeed: 0.1,
      maxScrubSpeed: 10,
      acceleration: 0.05,
      direction: 0, // -1 = backward, 0 = none, 1 = forward
      indicator: null,
      directionElement: null,
      ghost: null,
      inertiaEnabled: true,
      inertiaValue: 0,
      inertiaDamping: 0.95,
      
      init() {
        this.indicator = document.getElementById('scrub-indicator');
        this.directionElement = document.getElementById('scrub-direction');
        this.ghost = document.getElementById('scrub-ghost');
        
        // Set up event listeners
        document.addEventListener('mousedown', this.onStart.bind(this));
        document.addEventListener('mousemove', this.onMove.bind(this));
        document.addEventListener('mouseup', this.onEnd.bind(this));
        
        document.addEventListener('touchstart', this.onStart.bind(this), { passive: true });
        document.addEventListener('touchmove', this.onMove.bind(this), { passive: true });
        document.addEventListener('touchend', this.onEnd.bind(this), { passive: true });
        
        // Keyboard controls for scrubbing
        document.addEventListener('keydown', (event) => {
          if (event.key === 'ArrowLeft') {
            this.scrubWithKey(-1);
          } else if (event.key === 'ArrowRight') {
            this.scrubWithKey(1);
          }
        });
      },
      
      onStart(event) {
        // Only start dragging from the canvas (not on UI elements)
        const target = event.target;
        if (target.id !== 'cycleCanvas') return;
        
        // Get starting position
        if (event.type === 'touchstart') {
          this.startX = event.touches[0].clientX;
          this.lastX = this.startX;
        } else {
          this.startX = event.clientX;
          this.lastX = this.startX;
        }
        
        this.isDragging = true;
        this.scrubSpeed = 1;
        this.direction = 0;
        this.updateIndicator();
        
        // Pause the simulation while scrubbing
        if (!isPaused) {
          window.wasPlaying = true;
          togglePause();
        } else {
          window.wasPlaying = false;
        }
        
        // Unlock audio
        SoundManager.unlock();
      },
      
      onMove(event) {
        if (!this.isDragging) return;
        
        let currentX;
        if (event.type === 'touchmove') {
          currentX = event.touches[0].clientX;
        } else {
          currentX = event.clientX;
        }
        
        const deltaX = currentX - this.lastX;
        this.lastX = currentX;
        
        // Determine direction and update scrub speed
        if (deltaX > 0) {
          // Moving right (forward in time)
          this.direction = 1;
          this.scrubSpeed = Math.min(this.scrubSpeed + this.acceleration, this.maxScrubSpeed);
          this.directionElement.textContent = '→';
          this.ghost.className = 'scrub-ghost forward';
        } else if (deltaX < 0) {
          // Moving left (backward in time)
          this.direction = -1;
          this.scrubSpeed = Math.min(this.scrubSpeed + this.acceleration, this.maxScrubSpeed);
          this.directionElement.textContent = '←';
          this.ghost.className = 'scrub-ghost backward';
        } else {
          // Not moving
          this.scrubSpeed = Math.max(this.scrubSpeed - this.acceleration, this.minScrubSpeed);
        }
        
        // Update time based on direction and speed
        if (this.direction !== 0) {
          // Calculate movement amount
          const moveAmount = Math.abs(deltaX) * this.sensitivity * this.scrubSpeed;
          time += moveAmount * this.direction;
          
          // Ensure time doesn't go below 0
          if (time < 0) time = 0;
          
          // Update UI
          document.getElementById('time-scrub').value = time;
          updateDateDisplay();
          
          // Show scrub indicator
          this.updateIndicator(true);
          
          // Play subtle scrub sound occasionally
          if (Math.random() < 0.05 && !settings.muteSound) {
            const baseFreq = this.direction > 0 ? 800 : 400;
            SoundManager.playTone(baseFreq + Math.random() * 200, 0.05, 'sine', 0.1);
          }
        }
      },
      
      onEnd() {
        if (!this.isDragging) return;
        
        this.isDragging = false;
        
        // Store inertia for smooth deceleration
        if (this.inertiaEnabled) {
          this.inertiaValue = this.direction * this.scrubSpeed * 0.3;
          this.applyInertia();
        }
        
        // Hide the indicator and ghost
        setTimeout(() => {
          this.updateIndicator(false);
          this.ghost.className = 'scrub-ghost';
        }, 200);
        
        // Resume simulation if it was playing before
        if (window.wasPlaying) {
          togglePause();
        }
      },
      
      applyInertia() {
        if (Math.abs(this.inertiaValue) < 0.05) return;
        
        // Apply inertia to time
        time += this.inertiaValue;
        if (time < 0) time = 0;
        
        // Update UI
        document.getElementById('time-scrub').value = time;
        updateDateDisplay();
        
        // Reduce inertia value
        this.inertiaValue *= this.inertiaDamping;
        
        // Continue inertia
        requestAnimationFrame(() => this.applyInertia());
      },
      
      updateIndicator(show = true) {
        if (show) {
          this.indicator.classList.add('active');
        } else {
          this.indicator.classList.remove('active');
        }
      },
      
      scrubWithKey(direction) {
        // Scrub with keyboard arrow keys
        const amount = 10 * direction;
        time += amount;
        if (time < 0) time = 0;
        
        // Update UI
        document.getElementById('time-scrub').value = time;
        updateDateDisplay();
        
        // Show feedback
        this.direction = direction;
        this.directionElement.textContent = direction > 0 ? '→' : '←';
        this.updateIndicator(true);
        this.ghost.className = `scrub-ghost ${direction > 0 ? 'forward' : 'backward'}`;
        
        // Hide after short delay
        setTimeout(() => {
          this.updateIndicator(false);
          this.ghost.className = 'scrub-ghost';
        }, 200);
        
        // Play a subtle tone
        if (!settings.muteSound) {
          const baseFreq = direction > 0 ? 800 : 400;
          SoundManager.playTone(baseFreq, 0.05, 'sine', 0.1);
        }
      }
    };
    
    /******************************************
     * VISUALIZATION CORE
    ******************************************/
    let cycleCanvas, cycleCtx;
    let cycleWidth, cycleHeight;
    let time = 0;
    let isPaused = false;
    let speedMultiplier = 0.05;
    let harmonicFactor = 1.0;
    let resonanceSensitivity = 1.0;
    let lastFrameTime = 0;
    let particles = [];
    let isModalOpen = false;
    let isKeyboardHelpVisible = false;
    let isSettingsPanelOpen = false;
    let activeResonances = [];
    let lastResonanceTime = 0;
    
    const CYCLES = [
      { name: "1461: Institutional Accumulation", length: 1461, hue: 0, importance: 10 },
      { name: "741: Short Squeeze Trigger", length: 741, hue: 60, importance: 8 },
      { name: "55: FOMO Swing", length: 55, hue: 30, importance: 6 },
      { name: "35: Momentum Surge", length: 35, hue: 0, importance: 5 },
      { name: "21: Intraday Pulse", length: 21, hue: 60, importance: 4 },
      { name: "999: The Tesla Loop", length: 999, hue: 330, importance: 10 }
    ];
    
    function applyTheme() {
      document.documentElement.classList.toggle('light-theme', settings.lightTheme);
      document.getElementById('theme-toggle').textContent = settings.lightTheme ? '🌙' : '☀️';
    }
    
    function setupCanvas() {
      try {
        cycleCanvas = document.getElementById('cycleCanvas');
        cycleCtx = cycleCanvas.getContext('2d');
        
        // Set initial canvas size
        cycleWidth = window.innerWidth;
        cycleHeight = window.innerHeight;
        cycleCanvas.width = cycleWidth;
        cycleCanvas.height = cycleHeight;
        
        // Handle high DPI displays
        const dpr = window.devicePixelRatio || 1;
        cycleCanvas.width = cycleWidth * dpr;
        cycleCanvas.height = cycleHeight * dpr;
        cycleCanvas.style.width = cycleWidth + 'px';
        cycleCanvas.style.height = cycleHeight + 'px';
        cycleCtx.scale(dpr, dpr);
        
        window.addEventListener('resize', function() {
          // Simple immediate resize, no debouncing
          cycleWidth = window.innerWidth;
          cycleHeight = window.innerHeight;
          cycleCanvas.style.width = cycleWidth + 'px';
          cycleCanvas.style.height = cycleHeight + 'px';
          cycleCanvas.width = cycleWidth * dpr;
          cycleCanvas.height = cycleHeight * dpr;
          cycleCtx.scale(dpr, dpr);
        });
        
        return true;
      } catch (e) {
        console.log("Canvas setup error:", e);
        return false;
      }
    }
    
    function initializeControls() {
      // Control buttons
      document.getElementById('pause-btn').addEventListener('click', function() {
        togglePause();
        // Unlock audio on first interaction
        SoundManager.unlock();
      });
      
      document.getElementById('reset-btn').addEventListener('click', function() {
        resetTime();
        SoundManager.unlock();
      });
      
      document.getElementById('speed-down-btn').addEventListener('click', function() {
        speedDown();
        SoundManager.unlock();
      });
      
      document.getElementById('speed-up-btn').addEventListener('click', function() {
        speedUp();
        SoundManager.unlock();
      });
      
      document.getElementById('info-btn').addEventListener('click', function() {
        showModal('info-tab');
        SoundManager.unlock();
      });
      
      document.getElementById('settings-btn').addEventListener('click', function() {
        toggleSettings();
        SoundManager.unlock();
      });
      
      document.getElementById('settings-close').addEventListener('click', toggleSettings);
      
      // Side controls
      document.getElementById('theme-toggle').addEventListener('click', function() {
        toggleTheme();
        SoundManager.unlock();
      });
      
      document.getElementById('help-button').addEventListener('click', function() {
        toggleKeyboardHelp();
        SoundManager.unlock();
      });
      
      document.getElementById('toggle-legend').addEventListener('click', function() {
        toggleLegend();
        SoundManager.unlock();
      });
      
      document.getElementById('legend-header').addEventListener('click', toggleLegend);
      
      // Modal
      document.getElementById('modal-close').addEventListener('click', closeModal);
      document.getElementById('modal-overlay').addEventListener('click', closeModal);
      document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          e.target.classList.add('active');
          document.getElementById(e.target.dataset.tab).classList.add('active');
          
          const titles = {
            'info-tab': 'GME Cycle Information',
            'options-tab': 'GME Options Strategy',
            'api-tab': 'Trading API & Overlays'
          };
          document.getElementById('modal-title').textContent = titles[e.target.dataset.tab];
        });
      });
      
      // Copy button
      document.getElementById('copy-pinescript').addEventListener('click', function() {
        const code = document.querySelector('.code-block').textContent;
        
        navigator.clipboard.writeText(code)
          .then(() => showNotification("Code copied", "success"))
          .catch(() => showNotification("Copy failed", "error"));
      });
      
      // Settings
      document.getElementById('harmonicSlider').addEventListener('input', (e) => {
        harmonicFactor = parseFloat(e.target.value);
        document.getElementById('harmonic-value').textContent = harmonicFactor.toFixed(2);
        saveSettings();
      });
      
      document.getElementById('sensitivitySlider').addEventListener('input', (e) => {
        resonanceSensitivity = parseFloat(e.target.value);
        document.getElementById('sensitivity-value').textContent = resonanceSensitivity.toFixed(2);
        saveSettings();
      });
      
      document.getElementById('muteSound').addEventListener('change', (e) => {
        settings.muteSound = e.target.checked;
        saveSettings();
        
        if (settings.muteSound) {
          showNotification("Sound muted", "info");
        } else {
          showNotification("Sound enabled", "info");
          // Play a test sound
          SoundManager.playTone(440, 0.2);
        }
      });
      
      document.getElementById('time-scrub').addEventListener('input', (e) => {
        time = parseInt(e.target.value, 10);
        updateDateDisplay();
      });
      
      // Cycle items in legend
      document.querySelectorAll('.cycle-item').forEach(item => {
        item.addEventListener('click', e => {
          const cycleId = parseInt(e.currentTarget.dataset.cycle, 10);
          const cycle = CYCLES.find(c => c.length === cycleId);
          if (cycle) {
            highlightCycle(cycle);
            SoundManager.playTone(300 + Math.random() * 200, 0.3);
          }
          
          // Unlock audio on first interaction
          SoundManager.unlock();
        });
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        // Unlock audio on any key press
        SoundManager.unlock();
        
        if (e.key === " ") togglePause();
        else if (e.key === "r" || e.key === "R") resetTime();
        else if (e.key === "ArrowUp") speedUp();
        else if (e.key === "ArrowDown") speedDown();
        else if (e.key === "i" || e.key === "I") showModal('info-tab');
        else if (e.key === "o" || e.key === "O") showModal('options-tab');
        else if (e.key === "t" || e.key === "T") toggleTheme();
        else if (e.key === "Escape") handleEscape();
      });
      
      // General document click for audio unlock
      document.addEventListener('click', function() {
        SoundManager.unlock();
      });
      
      document.addEventListener('touchstart', function() {
        SoundManager.unlock();
      });
      
      // Initialize timeline scrubber
      TimelineScrubber.init();
    }
    
    function handleEscape() {
      if (isModalOpen) closeModal();
      else if (isSettingsPanelOpen) toggleSettings();
      else if (isKeyboardHelpVisible) toggleKeyboardHelp();
    }
    
    function togglePause() {
      isPaused = !isPaused;
      document.getElementById('pause-btn').textContent = isPaused ? "▶️" : "⏸️";
      showNotification(isPaused ? "Paused" : "Running", "info");
      
      // Play a sound when toggling
      if (!settings.muteSound) {
        SoundManager.playTone(isPaused ? 330 : 440, 0.1);
      }
    }
    
    function resetTime() {
      time = 0;
      particles = [];
      activeResonances = [];
      document.getElementById('time-scrub').value = 0;
      updateDateDisplay();
      showNotification("Timeline reset", "success");
      
      // Reset resonance indicator
      document.getElementById('resonance-indicator').textContent = "Resonance: Off";
      document.getElementById('resonance-indicator').classList.remove('active');
      document.getElementById('logo-container').classList.remove('resonating');
      
      // Reset cycle indicators
      document.querySelectorAll('.cycle-item').forEach(item => {
        item.classList.remove('resonating');
      });
      
      // Play a reset sound
      if (!settings.muteSound) {
        SoundManager.playTone(587.33, 0.2); // D5
      }
    }
    
    function speedDown() {
      speedMultiplier = Math.max(speedMultiplier / 1.5, 0.01);
      document.getElementById('time-speed').textContent = `${speedMultiplier.toFixed(2)}x`;
      
      // Play a speed change sound
      if (!settings.muteSound) {
        SoundManager.playTone(220, 0.1); // A3
      }
    }
    
    function speedUp() {
      speedMultiplier = Math.min(speedMultiplier * 1.5, 10);
      document.getElementById('time-speed').textContent = `${speedMultiplier.toFixed(2)}x`;
      
      // Play a speed change sound
      if (!settings.muteSound) {
        SoundManager.playTone(880, 0.1); // A5
      }
    }
    
    function toggleSettings() {
      isSettingsPanelOpen = !isSettingsPanelOpen;
      document.getElementById('settings-panel').classList.toggle('show', isSettingsPanelOpen);
      
      // Play a toggle sound
      if (!settings.muteSound && isSettingsPanelOpen) {
        SoundManager.playTone(523.25, 0.1); // C5
      }
    }
    
    function toggleLegend() {
      const legend = document.getElementById('legend');
      legend.classList.toggle('open');
      settings.legendOpen = legend.classList.contains('open');
      saveSettings();
      
      // Play a toggle sound
      if (!settings.muteSound) {
        SoundManager.playTone(392, 0.1); // G4
      }
    }
    
    function toggleKeyboardHelp() {
      isKeyboardHelpVisible = !isKeyboardHelpVisible;
      document.getElementById('keyboard-shortcuts').classList.toggle('show', isKeyboardHelpVisible);
      
      // Play a toggle sound
      if (!settings.muteSound && isKeyboardHelpVisible) {
        SoundManager.playTone(466.16, 0.1); // Bb4
      }
    }
    
    function toggleTheme() {
      settings.lightTheme = !settings.lightTheme;
      applyTheme();
      saveSettings();
      showNotification(settings.lightTheme ? "Light theme" : "Dark theme", "info");
      
      // Play a theme change sound
      if (!settings.muteSound) {
        SoundManager.playTone(settings.lightTheme ? 587.33 : 349.23, 0.2);
      }
    }
    
    function showModal(tabId) {
      document.getElementById('modal-overlay').classList.add('show');
      document.getElementById('main-modal').classList.add('show');
      
      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.modal-tab[data-tab="${tabId}"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
      
      const titles = {
        'info-tab': 'GME Cycle Information',
        'options-tab': 'GME Options Strategy',
        'api-tab': 'Trading API & Overlays'
      };
      document.getElementById('modal-title').textContent = titles[tabId];
      
      isModalOpen = true;
      
      // Play a modal open sound
      if (!settings.muteSound) {
        SoundManager.playTone(523.25, 0.2); // C5
      }
    }
    
    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('show');
      document.getElementById('main-modal').classList.remove('show');
      isModalOpen = false;
      
      // Play a modal close sound
      if (!settings.muteSound) {
        SoundManager.playTone(261.63, 0.15); // C4
      }
    }
    
    function updateDateDisplay() {
      const currentDate = new Date(new Date(2021, 0, 28).getTime() + time * 86400000);
      const formatted = currentDate.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });
      document.getElementById('date-display').textContent = formatted;
    }
    
    function showNotification(msg, type = "info", duration = 2000) {
      const notification = document.getElementById('notification');
      
      // Clear any existing notification timer
      clearTimeout(notification.timer);
      
      // Default styling
      notification.style.borderLeft = "4px solid var(--highlight)";
      notification.style.background = "rgba(0, 255, 204, 0.05)";
      
      // Apply specific styling based on type
      switch (type) {
        case "error":
          notification.style.borderLeft = "4px solid #ff3333";
          notification.style.background = "rgba(255, 51, 51, 0.1)";
          notification.classList.remove('resonance');
          break;
        case "success":
          notification.style.borderLeft = "4px solid #00ffcc";
          notification.style.background = "rgba(0, 255, 204, 0.1)";
          notification.classList.remove('resonance');
          break;
        case "resonance":
          notification.classList.add('resonance');
          duration = 4000; // Longer duration for resonance notifications
          break;
        default:
          notification.classList.remove('resonance');
          break;
      }
      
      notification.textContent = msg;
      notification.classList.add('show');
      
      // Set a timer to hide the notification
      notification.timer = setTimeout(() => {
        notification.classList.remove('show');
      }, duration);
    }
    
    function highlightCycle(cycle) {
      showNotification(`Cycle Selected: ${cycle.name}`, "info");
      
      // Find the corresponding legend item
      const legendItem = document.getElementById(`legend-${cycle.length}`);
      if (legendItem) {
        // Add a temporary highlight class
        legendItem.classList.add('resonating');
        
        // Remove the class after a delay
        setTimeout(() => {
          legendItem.classList.remove('resonating');
        }, 2000);
        
        // Add some particles around the cycle
        const cx = cycleWidth / 2;
        const cy = cycleHeight / 2;
        const spacing = Math.min(cycleWidth, cycleHeight) / (2 * CYCLES.length + 2);
        const cycleIndex = CYCLES.findIndex(c => c.length === cycle.length);
        const radius = spacing * (CYCLES.length - cycleIndex + 1);
        
        // Add particles in a circle around the highlighted cycle
        for (let i = 0; i < 12; i++) {
          const angle = (i / 12) * Math.PI * 2;
          const x = cx + Math.cos(angle) * radius;
          const y = cy + Math.sin(angle) * radius;
          spawnParticle(x, y, cycle.hue, 1.5);
        }
      }
    }
    
    function checkResonance() {
      // Calculate progress for each cycle and store in an array
      const progresses = CYCLES.map(cycle => (time % cycle.length) / cycle.length);
      
      // Reset active resonances
      activeResonances = [];
      
      // Threshold is adjusted by sensitivity setting
      const baseThreshold = 0.03;
      const threshold = baseThreshold / resonanceSensitivity;
      
      // Check for resonance between any two cycles
      for (let i = 0; i < progresses.length; i++) {
        for (let j = i + 1; j < progresses.length; j++) {
          const diff = Math.abs(progresses[i] - progresses[j]);
          
          if (diff < threshold || Math.abs(1 - diff) < threshold) {
            // Found a resonance!
            activeResonances.push([i, j]);
          }
        }
      }
      
      // Return whether any resonances were found
      return activeResonances.length > 0;
    }
    
    function handleResonances() {
      if (activeResonances.length === 0) {
        // No resonances - reset indicators
        document.getElementById('resonance-indicator').textContent = "Resonance: Off";
        document.getElementById('resonance-indicator').classList.remove('active');
        document.getElementById('logo-container').classList.remove('resonating');
        
        // Reset all cycle items
        document.querySelectorAll('.cycle-item').forEach(item => {
          item.classList.remove('resonating');
        });
        
        return;
      }
      
      // Process the resonances
      const cx = cycleWidth / 2;
      const cy = cycleHeight / 2;
      const spacing = Math.min(cycleWidth, cycleHeight) / (2 * CYCLES.length + 2);
      
      // Activate logo pulse animation
      document.getElementById('logo-container').classList.add('resonating');
      
      // Draw resonance connections and highlight cycles
      activeResonances.forEach(([i, j]) => {
        const cycle1 = CYCLES[i];
        const cycle2 = CYCLES[j];
        
        // Calculate position on rings
        const prog1 = (time % cycle1.length) / cycle1.length;
        const prog2 = (time % cycle2.length) / cycle2.length;
        
        const radius1 = spacing * (CYCLES.length - i + 1);
        const radius2 = spacing * (CYCLES.length - j + 1);
        
        const angle1 = prog1 * 2 * Math.PI;
        const angle2 = prog2 * 2 * Math.PI;
        
        const x1 = cx + Math.cos(angle1) * radius1;
        const y1 = cy + Math.sin(angle1) * radius1;
        const x2 = cx + Math.cos(angle2) * radius2;
        const y2 = cy + Math.sin(angle2) * radius2;
        
        // Draw connection line with glow effect
        cycleCtx.beginPath();
        cycleCtx.moveTo(x1, y1);
        cycleCtx.lineTo(x2, y2);
        cycleCtx.strokeStyle = 'var(--resonance-color)';
        cycleCtx.lineWidth = 3;
        cycleCtx.shadowColor = 'var(--highlight)';
        cycleCtx.shadowBlur = 10;
        cycleCtx.stroke();
        cycleCtx.shadowBlur = 0;
        
        // Add particles to connection
        if (Math.random() < 0.2) {
          const midX = (x1 + x2) / 2;
          const midY = (y1 + y2) / 2;
          spawnParticle(midX, midY, Math.random() * 360, 1.2);
        }
        
        // Highlight resonating cycles in the legend
        const item1 = document.getElementById(`legend-${cycle1.length}`);
        const item2 = document.getElementById(`legend-${cycle2.length}`);
        
        if (item1) item1.classList.add('resonating');
        if (item2) item2.classList.add('resonating');
      });
      
      // Update resonance indicator text
      if (activeResonances.length > 0) {
        const cycleNames = activeResonances.map(([i, j]) => 
          `${CYCLES[i].length} & ${CYCLES[j].length}`
        ).join(', ');
        
        document.getElementById('resonance-indicator').textContent = `Resonance: ${cycleNames}`;
        document.getElementById('resonance-indicator').classList.add('active');
        
        // Show notification and play sound if this is a new resonance (not too frequently)
        const now = performance.now();
        if (now - lastResonanceTime > 3000) {
          lastResonanceTime = now;
          
          // Notification
          showNotification(`Cycle Resonance Detected: ${cycleNames}`, "resonance");
          
          // Sound
          if (!settings.muteSound) {
            SoundManager.playResonance();
          }
        }
      }
    }
    
    function animate(timestamp) {
      // Limit update rate
      if (timestamp - lastFrameTime < 16) {
        requestAnimationFrame(animate);
        return;
      }
      lastFrameTime = timestamp;
      
      // Clear canvas
      cycleCtx.clearRect(0, 0, cycleWidth, cycleHeight);
      
      // Draw cycles
      const cx = cycleWidth / 2;
      const cy = cycleHeight / 2;
      const spacing = Math.min(cycleWidth, cycleHeight) / (2 * CYCLES.length + 2);
      
      // Draw each cycle ring
      CYCLES.forEach((cycle, i) => {
        const progress = (time % cycle.length) / cycle.length;
        const radius = spacing * (CYCLES.length - i + 1);
        const angle = progress * 2 * Math.PI;
        const hue = cycle.hue;
        const color = `hsl(${hue}, 100%, 50%)`;
        
        // Draw circle
        cycleCtx.beginPath();
        cycleCtx.arc(cx, cy, radius, 0, 2 * Math.PI);
        cycleCtx.strokeStyle = `hsla(${hue}, 100%, 30%, 0.4)`;
        cycleCtx.lineWidth = 1;
        cycleCtx.stroke();
        
        // Draw progress arc
        cycleCtx.beginPath();
        cycleCtx.arc(cx, cy, radius, 0, angle);
        cycleCtx.strokeStyle = color;
        cycleCtx.lineWidth = 3;
        cycleCtx.stroke();
        
        // Draw marker
        const mx = cx + Math.cos(angle) * radius;
        const my = cy + Math.sin(angle) * radius;
        cycleCtx.beginPath();
        cycleCtx.arc(mx, my, 5, 0, 2 * Math.PI);
        cycleCtx.fillStyle = '#fff';
        cycleCtx.fill();
      });
      
      // Check for and handle resonances
      checkResonance();
      handleResonances();
      
      // Handle particles
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.02;
        
        if (p.life <= 0) {
          particles.splice(i, 1);
        } else {
          cycleCtx.beginPath();
          cycleCtx.arc(p.x, p.y, p.size, 0, 2 * Math.PI);
          cycleCtx.fillStyle = `hsla(${p.hue}, 100%, 50%, ${p.life})`;
          cycleCtx.fill();
        }
      }
      
      // Update time if not paused
      if (!isPaused) {
        time += speedMultiplier;
        document.getElementById('time-scrub').value = time;
        
        // Only update date display occasionally for performance
        if (Math.random() < 0.05) {
          updateDateDisplay();
        }
      }
      
      requestAnimationFrame(animate);
    }
    
    function spawnParticle(x, y, hue, sizeMultiplier = 1) {
      const size = (Math.random() * 3 + 2) * sizeMultiplier;
      particles.push({
        x,
        y,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        size,
        hue,
        life: 1
      });
      
      // Limit particles for performance
      if (particles.length > 80) {
        particles.splice(0, particles.length - 80);
      }
    }
    
    // SIMPLIFIED APP INITIALIZATION
    function startApp() {
      try {
        // Load settings
        settings = loadSettings();
        applyTheme();
        
        // Apply UI state from settings
        if (settings.legendOpen) {
          document.getElementById('legend').classList.add('open');
        }
        
        document.getElementById('muteSound').checked = settings.muteSound;
        document.getElementById('harmonicSlider').value = settings.harmonicFactor;
        document.getElementById('sensitivitySlider').value = settings.resonanceSensitivity || 1.0;
        document.getElementById('harmonic-value').textContent = settings.harmonicFactor.toFixed(2);
        document.getElementById('sensitivity-value').textContent = (settings.resonanceSensitivity || 1.0).toFixed(2);
        
        harmonicFactor = settings.harmonicFactor;
        resonanceSensitivity = settings.resonanceSensitivity || 1.0;
        
        // Setup initial UI
        document.getElementById('time-speed').textContent = `${speedMultiplier.toFixed(2)}x`;
        updateDateDisplay();
        
        // Initialize controls after UI is ready
        initializeControls();
        
        // Start canvas animations
        if (setupCanvas()) {
          requestAnimationFrame(animate);
        }
        
        // Create a few initial particles
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        for (let i = 0; i < 10; i++) {
          spawnParticle(
            cx + (Math.random() - 0.5) * 100,
            cy + (Math.random() - 0.5) * 100,
            Math.random() * 360
          );
        }
        
        // Begin initializing the sound system
        SoundManager.init();
        
        // Hide loading screen
        document.getElementById('loading').classList.add('done');
        clearTimeout(loadingTimeout);
      } catch (e) {
        console.error("Initialization error:", e);
        
        // Make sure loading screen goes away even if there's an error
        document.getElementById('loading').classList.add('done');
        clearTimeout(loadingTimeout);
        
        // Show error notification
        showNotification("Something went wrong. Try refreshing.", "error");
      }
    }
    
    // Start loading and then initialize the app
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(startApp, 500); // Short delay to ensure DOM is ready
    });
  </script>
</body>
</html>