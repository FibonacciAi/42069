<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Cycle Resonance Visualization ‚Äì Enhanced" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cycle Resonance Visualization ‚Äì Enhanced</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Base Theme Variables */
      --bg-color: #0f0f13;
      --text-color: #ffffff;
      --panel-bg: rgba(15, 15, 19, 0.85);
      --highlight: #2196F3;
      /* Cycle Colors */
      --limegreen-color: #32CD32;
      --skyblue-color: #87CEFA;
      --orange-color: #FFA500;
      --pink-color: #FF69B4;
      --gold-color: #FFD700;
      --blueviolet-color: rgba(138, 43, 226, 0.8);
      --orangered-color: rgba(255, 69, 0, 0.8);
      --turquoise-color: #40E0D0;
      --purple-color: #800080;
    }
    /* Reset & Base Styling */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }
    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Inter', system-ui, sans-serif;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    /* Layout Containers */
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    /* Canvas */
    #cycleCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    /* Controls & Legend Panels */
    .controls,
    .legend {
      position: absolute;
      width: 90%;
      max-width: 800px;
      background: var(--panel-bg);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      z-index: 4;
      padding: 0.5rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .controls {
      top: 20px;
      justify-content: space-between;
      align-items: center;
    }
    /* Group all control buttons and toggles together */
    .control-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls button, .controls input[type="checkbox"] {
      margin-right: 10px;
    }
    .controls label {
      font-size: 0.85rem;
      cursor: pointer;
    }
    .date-display {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
      text-align: center;
    }
    /* Debug Overlay */
    #debugOverlay {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      padding: 8px;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
      z-index: 6;
      display: none;
    }
    /* Logo & Emoji */
    .logo-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: auto;
    }
    #custom-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      transition: opacity 0.5s ease-in-out;
      opacity: 0;
      object-fit: cover;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #custom-logo.loaded { opacity: 1; }
    .emoji {
      position: absolute;
      top: -30px;
      font-size: 24px;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }
    .emoji.active {
      opacity: 1;
      transform: translateY(-10px);
    }
    .emoji.fire { left: 50%; transform: translateX(-50%); }
    .emoji.boom { left: 60%; transform: translateX(-50%); }
    .emoji.beer { left: 40%; transform: translateX(-50%); }
    /* Legend */
    .legend ul {
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      gap: 15px;
      justify-content: center;
      width: 100%;
    }
    .legend li {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1 1 120px;
      justify-content: center;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .legend li.active {
      background: rgba(255,255,255,0.2);
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
    }
    .legend-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    /* Sound Wave Animation */
    .sound-wave {
      position: absolute;
      border: 2px solid var(--highlight);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: expand 1s linear infinite;
      opacity: 0.6;
      pointer-events: none;
      z-index: 5;
      display: none;
    }
    @keyframes expand {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
      100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }
    /* Tooltip */
    .tooltip {
      position: absolute;
      padding: 6px 10px;
      background: var(--panel-bg);
      color: var(--text-color);
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      pointer-events: none;
      z-index: 999;
      display: none;
      font-size: 0.8rem;
      white-space: pre-line;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .controls { width: 95%; top: 10px; }
      .legend { bottom: 50px; }
      #custom-logo { width: 35px; height: 35px; }
      .emoji { font-size: 20px; }
    }
    @media (max-width: 480px) {
      .controls { flex-direction: column; gap: 8px; align-items: center; }
      .controls button { min-width: 70px; padding: 6px 12px; font-size: 0.8rem; }
      .date-display { font-size: 0.8rem; margin-top: 8px; }
      .legend { bottom: 50px; padding: 0.5rem 0.75rem; gap: 10px; }
      .legend li { flex: 1 1 100px; }
      #custom-logo { width: 30px; height: 30px; }
      .emoji { font-size: 18px; }
    }
    @media (max-width: 320px) {
      .controls button { min-width: 60px; padding: 5px 8px; font-size: 0.7rem; }
      .date-display { font-size: 0.7rem; }
      .legend li { flex: 1 1 80px; }
      #custom-logo { width: 25px; height: 25px; }
      .emoji { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Controls Panel (with integrated toggles) -->
    <div class="controls" id="controls" role="region" aria-label="Animation Controls">
      <div class="control-buttons">
        <button id="pause-btn" aria-label="Pause/Play">Pause</button>
        <button id="reset-btn" aria-label="Reset Animation">Reset</button>
        <button id="speed-down-btn" aria-label="Decrease Speed">Slower</button>
        <button id="speed-up-btn" aria-label="Increase Speed">Faster</button>
        <label>
          <input type="checkbox" id="toggleMute">
          Mute Audio
        </label>
        <label>
          <input type="checkbox" id="toggleDebug">
          Show Debug
        </label>
        <label>
          <input type="checkbox" id="toggleFractal" checked>
          Show Fractals
        </label>
      </div>
      <div class="date-display" id="date-display">Current: [Loading...]</div>
    </div>
    <!-- Debug Overlay -->
    <div id="debugOverlay" aria-live="polite"></div>
    <!-- Logo & Emoji Container -->
    <div class="logo-container">
      <a href="#" target="_blank" rel="noopener noreferrer">
        <img id="custom-logo" src="https://fibonacciai.github.io/42069/power-512.png" alt="Power Logo" />
      </a>
      <span class="emoji fire" aria-hidden="true">üî•</span>
      <span class="emoji boom" aria-hidden="true">üí•</span>
      <span class="emoji beer" aria-hidden="true">üçª</span>
    </div>
    <!-- Canvas -->
    <canvas id="cycleCanvas">Your browser does not support the canvas element.</canvas>
    <!-- Legend Panel -->
    <div class="legend" id="legend" role="region" aria-label="Cycle Legend">
      <ul>
        <li data-cycle="1461"><span class="legend-dot" style="background: var(--limegreen-color);"></span> Main ~4yrs Cycle</li>
        <li data-cycle="1470"><span class="legend-dot" style="background: var(--blueviolet-color);"></span> 1470-day Cycle</li>
        <li data-cycle="1471"><span class="legend-dot" style="background: var(--orangered-color);"></span> 1471-day Cycle</li>
        <li data-cycle="741"><span class="legend-dot" style="background: var(--gold-color);"></span> 741-day Cycle</li>
        <li data-cycle="147"><span class="legend-dot" style="background: var(--skyblue-color);"></span> 147-day Cycle</li>
        <li data-cycle="55"><span class="legend-dot" style="background: var(--turquoise-color);"></span> 55-day Cycle</li>
        <li data-cycle="35"><span class="legend-dot" style="background: var(--orange-color);"></span> 35-day Cycle</li>
        <li data-cycle="21"><span class="legend-dot" style="background: var(--purple-color);"></span> 21-day Cycle</li>
      </ul>
    </div>
  </div>
  <!-- Sound Wave Element -->
  <div class="sound-wave" id="soundWave"></div>
  <!-- Tooltip -->
  <div id="tooltip" class="tooltip" role="tooltip"></div>

  <script type="module">
    /*****************************************************************************************************
     * OVERVIEW:
     * This code is our 741-dimensional chess board. It uses the 741 cycle to tie together macro events,
     * RK's return, RC's filings, and the BoJ rate hike. The narrative includes:
     *   1Ô∏è‚É£ 741 Cycle & RK‚Äôs Return:
     *         - RK returned on 5/12/24; 267 days to 2/3/25 ‚Üí 267/36 = 7.417, matching key posts.
     *   2Ô∏è‚É£ BoJ Yen Carry Trade & 1/26 Futures Crash:
     *         - The BoJ rate hike (0.25%) on 1/26/25 and subsequent futures hit.
     *   3Ô∏è‚É£ Volkswagen 2008 Parallels:
     *         - Short squeezes from supply crunches.
     *   4Ô∏è‚É£ The Requel Theory & Settlement Cycles:
     *         - T+35 liquidation clocks and forced coverings.
     * Key dates include:
     *   ‚Ä¢ 1/27/25: RC moves 36M shares personally.
     *   ‚Ä¢ 1/29/25: Catalyst; T+35 liquidation clock starts.
     *   ‚Ä¢ 2/10/25: Possible mirror event (2:10 clock theory).
     *   ‚Ä¢ 3/5/25: T+35 from 1/29 ‚Äì potential forced covering event.
     *****************************************************************************************************/
    /************************************
     * 1) CONFIG & INITIAL DATA
     ************************************/
    function initConfig() { }
    const CYCLES = [
      { name: 'Main ~4yrs (1461)', length: 1461, colorVar: '--limegreen-color' },
      { name: '1470-day', length: 1470, colorVar: '--blueviolet-color' },
      { name: '1471-day', length: 1471, colorVar: '--orangered-color' },
      { name: '741-day',  length: 741,  colorVar: '--gold-color' },
      { name: '147-day',  length: 147,  colorVar: '--skyblue-color' },
      { name: '55-day',   length: 55,   colorVar: '--turquoise-color' },
      { name: '35-day',   length: 35,   colorVar: '--orange-color' },
      { name: '21-day',   length: 21,   colorVar: '--purple-color' }
    ];
    const CRUCIAL_DATES = [
      new Date(2025, 0, 9),
      new Date(2025, 0, 12),
      new Date(2025, 0, 23),
      new Date(2025, 0, 28),
      new Date(2024, 4, 1),
      new Date(2025, 0, 29),
      new Date(2024, 11, 25)
    ];
    const EMOJI_DATES = {
      '2025-01-27': 'fire',
      '2025-01-28': 'boom',
      '2025-01-29': 'beer'
    };
    const START_DATE = new Date(2021, 0, 28);
    const LOCALSTORAGE_KEY = 'cycleSettingsAdv';
    const defaultSettings = {
      audioMuted: false,
      debugOverlay: false,
      fractalDetails: true,
      language: 'en'
    };
    // Key and Fibonacci cycles
    const FIBONACCI_CYCLES = [21, 34, 55, 89, 144, 233, 377, 610, 987, 1597];
    const KEY_CYCLES = [1461, 1470, 1471, 741, 147];
    function isKeyOrFibonacci(n) {
      return KEY_CYCLES.includes(n) || FIBONACCI_CYCLES.includes(n);
    }
    /************************************
     * 2) MINIMAL i18n (English Only)
     ************************************/
    const MESSAGES = {
      en: {
        muteAudioLabel: "Mute Audio",
        showDebugLabel: "Show Debug",
        showFractalLabel: "Show Fractals"
      }
    };
    function initI18n() { applyLanguage('en'); }
    function applyLanguage(lang) {
      const dict = MESSAGES[lang] || MESSAGES.en;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) { el.textContent = dict[key]; }
      });
    }
    /************************************
     * 3) AUDIO
     ************************************/
    let audioCtx;
    function initAudioContext() {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AudioContext();
      document.addEventListener('click', resumeAudioContext);
      document.addEventListener('touchstart', resumeAudioContext);
    }
    function resumeAudioContext() {
      if (audioCtx.state === 'suspended') { audioCtx.resume(); }
      document.removeEventListener('click', resumeAudioContext);
      document.removeEventListener('touchstart', resumeAudioContext);
    }
    function audioContextTime() { return audioCtx ? audioCtx.currentTime : performance.now() / 1000; }
    function scheduleTone(frequency, startTime, duration = 0.5) {
      if (settings.audioMuted) return;
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.frequency.setValueAtTime(frequency, startTime);
      oscillator.type = 'sine';
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.start(startTime);
      gainNode.gain.setValueAtTime(0.3, startTime);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
      oscillator.stop(startTime + duration);
    }
    function playPolyrhythm(frequencies, baseDuration = 0.5) {
      if (settings.audioMuted) return;
      const now = audioCtx.currentTime;
      frequencies.forEach((freq, index) => {
        scheduleTone(freq, now + index * 0.15, baseDuration);
      });
    }
    /************************************
     * 4) DRAWING UTILS
     ************************************/
    function drawCycleRing(ctx, x, y, radius, progress, color) {
      const angle = progress * 2 * Math.PI;
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();
      const markerX = x + Math.cos(angle) * radius;
      const markerY = y + Math.sin(angle) * radius;
      ctx.beginPath();
      ctx.arc(markerX, markerY, 6, 0, 2 * Math.PI);
      ctx.fillStyle = '#fff';
      ctx.fill();
    }
    function drawFractal(ctx, x, y, radius, depth, active) {
      if (!active || depth === 0) return;
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = 'rgba(255,215,0,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      const newRadius = radius * 0.5;
      for (let i = 0; i < 3; i++) {
        const angle = (i / 3) * 2 * Math.PI;
        const childX = x + newRadius * Math.cos(angle);
        const childY = y + newRadius * Math.sin(angle);
        drawFractal(ctx, childX, childY, newRadius, depth - 1, active);
      }
    }
    function showTooltip(tooltipEl, message, x, y) {
      tooltipEl.textContent = message;
      tooltipEl.style.left = (x + 10) + 'px';
      tooltipEl.style.top = (y + 10) + 'px';
      tooltipEl.style.display = 'block';
      setTimeout(() => { tooltipEl.style.display = 'none'; }, 2000);
    }
    function formatDate(date) {
      return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    function getCurrentDate(time) { return new Date(START_DATE.getTime() + time * 86400000); }
    /************************************
     * 5) MAIN LOGIC & LEGEND HIGHLIGHTING
     ************************************/
    let canvas, ctx;
    let time = 0;
    let isPaused = false;
    let isScrubbing = false;
    let scrubStartX = 0;
    let speedMultiplier = 0.05;
    let frameCount = 0;
    let lastDebugTime = performance.now();
    let triggeredResonances = new Set();
    let waves = [];
    // Timeline key dates for additional tooltips:
    const KEY_DATES = {
      "2025-01-27": "RC moves 36M shares personally",
      "2025-01-29": "Catalyst: T+35 liquidation clock starts",
      "2025-02-10": "Possible mirror event (2:10 clock theory)",
      "2025-03-05": "T+35 from 1/29 ‚Äì potential forced covering event"
    };
    function highlightLegend(cycleIdentifier) {
      const legendItem = document.querySelector(`.legend li[data-cycle="${cycleIdentifier}"]`);
      if (legendItem) {
        legendItem.classList.add('active');
        setTimeout(() => { legendItem.classList.remove('active'); }, 500);
      }
    }
    function checkKeyDates(currentDate, tooltipEl, x, y) {
      const iso = currentDate.toISOString().split('T')[0];
      if (KEY_DATES[iso]) {
        showTooltip(tooltipEl, KEY_DATES[iso], x, y);
      }
    }
    function loadSettings() { return Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '{}')); }
    const settings = loadSettings();
    function saveSettings() { localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(settings)); }
    /************************************
     * 6) RESONANCE & EVENT CHECKS
     ************************************/
    // When any alignment meets the threshold, we trigger a resonance.
    // For near-crucial alignments we play a fuller polyrhythm; otherwise, we schedule a deep thump (80 Hz)
    // and trigger extended haptic feedback (100 ms).
    function checkResonance(ctx, x, y, radius, progressA, progressB, currentDate, tooltipEl, cycleA, cycleB) {
      const alignmentThreshold = 0.02;
      const diff = Math.abs(progressA - progressB);
      const isAlignment = diff < alignmentThreshold || Math.abs(1 - diff) < alignmentThreshold;
      if (!isAlignment) return;
      const eventKey = `Res-${currentDate.toDateString()}-${radius}-${cycleA.name}-${cycleB.name}`;
      if (triggeredResonances.has(eventKey)) return;
      triggeredResonances.add(eventKey);
      // Check for nearby crucial dates:
      const dayThreshold = 1;
      const nearCrucial = CRUCIAL_DATES.some(cd => Math.abs((currentDate - cd) / 86400000) < dayThreshold);
      // Use the color of cycleA for the resonance ring:
      const cycleColor = getComputedStyle(document.documentElement).getPropertyValue(cycleA.colorVar).trim();
      ctx.beginPath();
      ctx.arc(x, y, radius * 1.1, 0, 2 * Math.PI);
      ctx.strokeStyle = cycleColor;
      ctx.lineWidth = 4;
      ctx.stroke();
      drawFractal(ctx, x, y, radius * 1.1, 1, settings.fractalDetails);
      // Audio & Haptic Feedback:
      if (nearCrucial) {
        playPolyrhythm([261.63, 329.63, 392.0], 0.75);
        showTooltip(tooltipEl, `Resonance (Crucial):\n${cycleA.name} & ${cycleB.name}\non ${formatDate(currentDate)}`, x, y);
      } else {
        scheduleTone(80, audioContextTime() + 0.1, 0.5);
        if (navigator.vibrate) { navigator.vibrate(100); }
        showTooltip(tooltipEl, `Resonance:\n${cycleA.name} & ${cycleB.name}`, x, y);
      }
      spawnWave(x, y, radius * 1.1);
      // Highlight legend for key/Fibonacci cycles.
      if (isKeyOrFibonacci(cycleA.length)) { highlightLegend(cycleA.length); }
      if (isKeyOrFibonacci(cycleB.length)) { highlightLegend(cycleB.length); }
      // Also, check for key timeline dates and add extra commentary.
      checkKeyDates(currentDate, tooltipEl, x, y);
    }
    function checkCrucialDates(ctx, x, y, currentDate, tooltipEl) {
      const dayThreshold = 1;
      const found = CRUCIAL_DATES.some(cd => Math.abs((currentDate - cd)/86400000) < dayThreshold);
      if (found) {
        const eventKey = `Crucial-${currentDate.toDateString()}`;
        if (!triggeredResonances.has(eventKey)) {
          triggeredResonances.add(eventKey);
          ctx.beginPath();
          ctx.arc(x, y, 150, 0, 2 * Math.PI);
          ctx.strokeStyle = 'rgba(255,165,0,0.8)';
          ctx.lineWidth = 4;
          ctx.stroke();
          scheduleTone(523.25, audioContextTime() + 0.1, 0.6);
          showTooltip(tooltipEl, `Crucial Date near\n${formatDate(currentDate)}`, x, y);
          spawnWave(x, y, 150);
        }
      }
    }
    function checkEmojiEvents(currentDate) {
      const formattedDate = currentDate.toISOString().split('T')[0];
      document.querySelector('.emoji.fire')
        .classList.toggle('active', EMOJI_DATES[formattedDate] === 'fire');
      document.querySelector('.emoji.boom')
        .classList.toggle('active', EMOJI_DATES[formattedDate] === 'boom');
      document.querySelector('.emoji.beer')
        .classList.toggle('active', EMOJI_DATES[formattedDate] === 'beer');
    }
    function spawnWave(x, y, startRadius = 0) {
      waves.push({ x, y, radius: startRadius, maxRadius: startRadius + 200, alpha: 1 });
    }
    function updateWaves() {
      for (let i = waves.length - 1; i >= 0; i--) {
        const w = waves[i];
        w.radius += 2;
        w.alpha -= 0.015;
        ctx.save();
        ctx.beginPath();
        ctx.arc(w.x, w.y, w.radius, 0, 2 * Math.PI);
        ctx.strokeStyle = `rgba(255,255,255,${w.alpha})`;
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
        if (w.radius >= w.maxRadius || w.alpha <= 0) { waves.splice(i, 1); }
      }
    }
    /************************************
     * 7) MAIN ANIMATION & EVENT HANDLERS
     ************************************/
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.resetTransform();
      ctx.scale(dpr, dpr);
    }
    function drawAllCycles(ctx, tooltipEl, dateDisplay) {
      const rect = canvas.getBoundingClientRect();
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const ringSpacing = Math.min(rect.width, rect.height) / (2 * CYCLES.length);
      const currentDate = getCurrentDate(time);
      dateDisplay.textContent = `Current: ${formatDate(currentDate)}`;
      let cycleProgresses = [];
      CYCLES.forEach((cycle, idx) => {
        const progress = (time % cycle.length) / cycle.length;
        cycleProgresses.push(progress);
        const ringRadius = ringSpacing * (CYCLES.length - idx);
        const color = getComputedStyle(document.documentElement)
                      .getPropertyValue(cycle.colorVar)
                      .trim();
        drawCycleRing(ctx, centerX, centerY, ringRadius, progress, color);
      });
      for (let i = 0; i < CYCLES.length; i++) {
        for (let j = i + 1; j < CYCLES.length; j++) {
          const cycleA = CYCLES[i];
          const cycleB = CYCLES[j];
          if (!isKeyOrFibonacci(cycleA.length) && !isKeyOrFibonacci(cycleB.length)) continue;
          const ringRadius = ringSpacing * (CYCLES.length - i);
          checkResonance(ctx, centerX, centerY, ringRadius,
            cycleProgresses[i], cycleProgresses[j],
            currentDate, tooltipEl, cycleA, cycleB);
        }
      }
      checkCrucialDates(ctx, centerX, centerY, currentDate, tooltipEl);
      checkEmojiEvents(currentDate);
    }
    function animate(dateDisplay, tooltipEl, debugOverlay) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawAllCycles(ctx, tooltipEl, dateDisplay);
      updateWaves();
      frameCount++;
      const now = performance.now();
      if (now - lastDebugTime >= 1000) {
        if (settings.debugOverlay) {
          const currentDate = getCurrentDate(time);
          debugOverlay.textContent = `FPS: ${frameCount} | Time: ${time.toFixed(2)} | Date: ${formatDate(currentDate)}`;
        }
        frameCount = 0;
        lastDebugTime = now;
      }
      if (!isPaused && !isScrubbing) { time += speedMultiplier; }
      requestAnimationFrame(() => animate(dateDisplay, tooltipEl, debugOverlay));
    }
    function togglePause() {
      isPaused = !isPaused;
      document.getElementById('pause-btn').textContent = isPaused ? 'Play' : 'Pause';
    }
    function resetTime() { time = 0; triggeredResonances.clear(); waves = []; }
    function speedDown() { speedMultiplier = Math.max(speedMultiplier / 2, 0.01); }
    function speedUp() { speedMultiplier = Math.min(speedMultiplier * 2, 16); }
    function onWheelScrub(e) {
      e.preventDefault();
      const baseSensitivity = 0.0005;
      const acceleration = Math.log(Math.abs(e.deltaY) + 1);
      time += e.deltaY * baseSensitivity * acceleration;
    }
    function onTouchStart(e) { isScrubbing = true; scrubStartX = e.touches[0].clientX; }
    function onTouchMove(e) {
      if (!isScrubbing) return;
      const currentX = e.touches[0].clientX;
      time += (currentX - scrubStartX) / 5;
      scrubStartX = currentX;
    }
    function onTouchEnd() { isScrubbing = false; }
    /************************************
     * 8) INITIALIZATION
     ************************************/
    function startVisualization() {
      canvas = document.getElementById('cycleCanvas');
      ctx = canvas.getContext('2d');
      const pauseBtn      = document.getElementById('pause-btn');
      const resetBtn      = document.getElementById('reset-btn');
      const speedDownBtn  = document.getElementById('speed-down-btn');
      const speedUpBtn    = document.getElementById('speed-up-btn');
      const dateDisplay   = document.getElementById('date-display');
      const toggleMute    = document.getElementById('toggleMute');
      const toggleDebug   = document.getElementById('toggleDebug');
      const toggleFractal = document.getElementById('toggleFractal');
      const debugOverlay  = document.getElementById('debugOverlay');
      const tooltipEl     = document.getElementById('tooltip');
      const logo          = document.getElementById('custom-logo');
      toggleMute.checked = settings.audioMuted;
      toggleDebug.checked = settings.debugOverlay;
      toggleFractal.checked = settings.fractalDetails;
      debugOverlay.style.display = settings.debugOverlay ? 'block' : 'none';
      toggleMute.addEventListener('change', (e) => { settings.audioMuted = e.target.checked; saveSettings(); });
      toggleDebug.addEventListener('change', (e) => { settings.debugOverlay = e.target.checked; debugOverlay.style.display = settings.debugOverlay ? 'block' : 'none'; saveSettings(); });
      toggleFractal.addEventListener('change', (e) => { settings.fractalDetails = e.target.checked; saveSettings(); });
      pauseBtn.addEventListener('click', togglePause);
      resetBtn.addEventListener('click', resetTime);
      speedDownBtn.addEventListener('click', speedDown);
      speedUpBtn.addEventListener('click', speedUp);
      document.addEventListener('keydown', (e) => {
        switch(e.key) {
          case ' ':
            e.preventDefault();
            togglePause();
            break;
          case 'r':
          case 'R':
            resetTime();
            break;
          case 'ArrowUp':
            speedUp();
            break;
          case 'ArrowDown':
            speedDown();
            break;
        }
      });
      canvas.addEventListener('wheel', onWheelScrub, { passive: false });
      canvas.addEventListener('touchstart', onTouchStart);
      canvas.addEventListener('touchmove', onTouchMove);
      canvas.addEventListener('touchend', onTouchEnd);
      logo.addEventListener('load', () => { logo.classList.add('loaded'); });
      window.addEventListener('resize', () => {
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(resizeCanvas, 200);
      });
      resizeCanvas();
      animate(dateDisplay, tooltipEl, debugOverlay);
    }
    /************************************
     * 9) INIT CALLS
     ************************************/
    initConfig();
   

Below is the final integrated HTML file. In this version:

‚Ä¢ The controls now include play/pause, reset, speed controls, plus the mute, debug, and fractal toggles all in one dock.  
‚Ä¢ The language selector and light theme toggle have been removed (English only).  
‚Ä¢ Resonance rings are drawn using the exact cycle color (from the associated cycle‚Äôs CSS variable).  
‚Ä¢ The non‚Äëcrucial resonance ‚Äúthump‚Äù uses a deep 80‚ÄØHz tone plus a 100‚Äëms vibration for extra ‚Äúthump.‚Äù  
‚Ä¢ In addition to the previously triggered audio notes, extra tooltips now appear on key dates (e.g. 1/27/25, 1/29/25, 2/10/25, and 3/5/25) as explained in your narrative.  
‚Ä¢ Inline commentary (in the code comments) describes the 741-dimensional chessboard logic‚Äîthe 741 cycle, the BoJ rate hike, the VW 2008 parallels, and the Requel theory.

Feel free to adjust any thresholds, tone frequencies, or narrative messages further.

---

```html
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Cycle Resonance Visualization ‚Äì Enhanced" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cycle Resonance Visualization ‚Äì Enhanced</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Base Theme Variables */
      --bg-color: #0f0f13;
      --text-color: #ffffff;
      --panel-bg: rgba(15, 15, 19, 0.85);
      --highlight: #2196F3;
      /* Cycle Colors */
      --limegreen-color: #32CD32;
      --skyblue-color: #87CEFA;
      --orange-color: #FFA500;
      --pink-color: #FF69B4;
      --gold-color: #FFD700;
      --blueviolet-color: rgba(138, 43, 226, 0.8);
      --orangered-color: rgba(255, 69, 0, 0.8);
      --turquoise-color: #40E0D0;
      --purple-color: #800080;
    }
    /* Reset & Base Styling */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }
    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Inter', system-ui, sans-serif;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    /* Layout Containers */
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    /* Canvas */
    #cycleCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      z-index: 1;
    }
    /* Controls & Legend Panels */
    .controls,
    .legend {
      position: absolute;
      width: 90%;
      max-width: 800px;
      background: var(--panel-bg);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 16px rgba(0,0,0,0.2);
      z-index: 4;
      padding: 0.5rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .controls {
      top: 20px;
      justify-content: space-between;
      align-items: center;
    }
    /* Group all control buttons and toggles together */
    .control-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls button, .controls input[type="checkbox"] {
      margin-right: 10px;
    }
    .controls label {
      font-size: 0.85rem;
      cursor: pointer;
    }
    .date-display {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.9);
      white-space: nowrap;
      text-align: center;
    }
    /* Debug Overlay */
    #debugOverlay {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      padding: 8px;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
      z-index: 6;
      display: none;
    }
    /* Logo & Emoji */
    .logo-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: auto;
    }
    #custom-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      transition: opacity 0.5s ease-in-out;
      opacity: 0;
      object-fit: cover;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #custom-logo.loaded { opacity: 1; }
    .emoji {
      position: absolute;
      top: -30px;
      font-size: 24px;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }
    .emoji.active {
      opacity: 1;
      transform: translateY(-10px);
    }
    .emoji.fire { left: 50%; transform: translateX(-50%); }
    .emoji.boom { left: 60%; transform: translateX(-50%); }
    .emoji.beer { left: 40%; transform: translateX(-50%); }
    /* Legend */
    .legend ul {
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      gap: 15px;
      justify-content: center;
      width: 100%;
    }
    .legend li {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1 1 120px;
      justify-content: center;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .legend li.active {
      background: rgba(255,255,255,0.2);
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
    }
    .legend-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    /* Sound Wave Animation */
    .sound-wave {
      position: absolute;
      border: 2px solid var(--highlight);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: expand 1s linear infinite;
      opacity: 0.6;
      pointer-events: none;
      z-index: 5;
      display: none;
    }
    @keyframes expand {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
      100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }
    /* Tooltip */
    .tooltip {
      position: absolute;
      padding: 6px 10px;
      background: var(--panel-bg);
      color: var(--text-color);
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      pointer-events: none;
      z-index: 999;
      display: none;
      font-size: 0.8rem;
      white-space: pre-line;
    }
    /* Responsive */
    @media (max-width: 768px) {
      .controls { width: 95%; top: 10px; }
      .legend { bottom: 50px; }
      #custom-logo { width: 35px; height: 35px; }
      .emoji { font-size: 20px; }
    }
    @media (max-width: 480px) {
      .controls { flex-direction: column; gap: 8px; align-items: center; }
      .controls button { min-width: 70px; padding: 6px 12px; font-size: 0.8rem; }
      .date-display { font-size: 0.8rem; margin-top: 8px; }
      .legend { bottom: 50px; padding: 0.5rem 0.75rem; gap: 10px; }
      .legend li { flex: 1 1 100px; }
      #custom-logo { width: 30px; height: 30px; }
      .emoji { font-size: 18px; }
    }
    @media (max-width: 320px) {
      .controls button { min-width: 60px; padding: 5px 8px; font-size: 0.7rem; }
      .date-display { font-size: 0.7rem; }
      .legend li { flex: 1 1 80px; }
      #custom-logo { width: 25px; height: 25px; }
      .emoji { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Controls Panel (Integrated toggles) -->
    <div class="controls" id="controls" role="region" aria-label="Animation Controls">
      <div class="control-buttons">
        <button id="pause-btn" aria-label="Pause/Play">Pause</button>
        <button id="reset-btn" aria-label="Reset Animation">Reset</button>
        <button id="speed-down-btn" aria-label="Decrease Speed">Slower</button>
        <button id="speed-up-btn" aria-label="Increase Speed">Faster</button>
        <label>
          <input type="checkbox" id="toggleMute">
          Mute Audio
        </label>
        <label>
          <input type="checkbox" id="toggleDebug">
          Show Debug
        </label>
        <label>
          <input type="checkbox" id="toggleFractal" checked>
          Show Fractals
        </label>
      </div>
      <div class="date-display" id="date-display">Current: [Loading...]</div>
    </div>
    <!-- Debug Overlay -->
    <div id="debugOverlay" aria-live="polite"></div>
    <!-- Logo & Emoji Container -->
    <div class="logo-container">
      <a href="#" target="_blank" rel="noopener noreferrer">
        <img id="custom-logo" src="https://fibonacciai.github.io/42069/power-512.png" alt="Power Logo" />
      </a>
      <span class="emoji fire" aria-hidden="true">üî•</span>
      <span class="emoji boom" aria-hidden="true">üí•</span>
      <span class="emoji beer" aria-hidden="true">üçª</span>
    </div>
    <!-- Canvas -->
    <canvas id="cycleCanvas">Your browser does not support the canvas element.</canvas>
    <!-- Legend Panel -->
    <div class="legend" id="legend" role="region" aria-label="Cycle Legend">
      <ul>
        <li data-cycle="1461"><span class="legend-dot" style="background: var(--limegreen-color);"></span> Main ~4yrs Cycle</li>
        <li data-cycle="1470"><span class="legend-dot" style="background: var(--blueviolet-color);"></span> 1470-day Cycle</li>
        <li data-cycle="1471"><span class="legend-dot" style="background: var(--orangered-color);"></span> 1471-day Cycle</li>
        <li data-cycle="741"><span class="legend-dot" style="background: var(--gold-color);"></span> 741-day Cycle</li>
        <li data-cycle="147"><span class="legend-dot" style="background: var(--skyblue-color);"></span> 147-day Cycle</li>
        <li data-cycle="55"><span class="legend-dot" style="background: var(--turquoise-color);"></span> 55-day Cycle</li>
        <li data-cycle="35"><span class="legend-dot" style="background: var(--orange-color);"></span> 35-day Cycle</li>
        <li data-cycle="21"><span class="legend-dot" style="background: var(--purple-color);"></span> 21-day Cycle</li>
      </ul>
    </div>
  </div>
  <!-- Sound Wave Element -->
  <div class="sound-wave" id="soundWave"></div>
  <!-- Tooltip -->
  <div id="tooltip" class="tooltip" role="tooltip"></div>

  <script type="module">
    /*****************************************************************************************************
     * OVERVIEW:
     * This code implements our 741-dimensional chess strategy.
     * ‚Ä¢ The 741 cycle ties together macro events, RK‚Äôs return, RC‚Äôs filings, and the BoJ rate hike.
     * ‚Ä¢ For example:
     *     - RK‚Äôs return on 5/12/24, 267 days to 2/3/25 yields 267/36 = 7.417.
     *     - RC‚Äôs 1/27/25 filing was exactly 741 days from his post.
     *     - RK‚Äôs livestream thumbnail references 7.41 at the BoJ rate hike moment.
     *
     * Additional narrative:
     *   1Ô∏è‚É£ 741 Cycle & RK‚Äôs Return: The 741 is a major breadcrumb tying macro events.
     *   2Ô∏è‚É£ BoJ Yen Carry Trade: The 1/26 rate hike + liquidity stress led to margin calls.
     *   3Ô∏è‚É£ VW 2008 Parallels: RC now controls a massive stake, making GME even harder to borrow.
     *   4Ô∏è‚É£ Requel Theory & Settlement Cycles: T+35 from key dates (e.g. 1/29/25 ‚Üí 3/5/25) may trigger forced covering.
     *
     * KEY DATES (for extra tooltips):
     *   ‚Ä¢ 2025-01-27: "RC moves 36M shares personally"
     *   ‚Ä¢ 2025-01-29: "Catalyst: T+35 liquidation clock starts"
     *   ‚Ä¢ 2025-02-10: "Possible mirror event (2:10 clock theory)"
     *   ‚Ä¢ 2025-03-05: "T+35 from 1/29 ‚Äì potential forced covering event"
     *****************************************************************************************************/
    /************************************
     * 1) CONFIG & INITIAL DATA
     ************************************/
    function initConfig() { }
    const CYCLES = [
      { name: 'Main ~4yrs (1461)', length: 1461, colorVar: '--limegreen-color' },
      { name: '1470-day', length: 1470, colorVar: '--blueviolet-color' },
      { name: '1471-day', length: 1471, colorVar: '--orangered-color' },
      { name: '741-day',  length: 741,  colorVar: '--gold-color' },
      { name: '147-day',  length: 147,  colorVar: '--skyblue-color' },
      { name: '55-day',   length: 55,   colorVar: '--turquoise-color' },
      { name: '35-day',   length: 35,   colorVar: '--orange-color' },
      { name: '21-day',   length: 21,   colorVar: '--purple-color' }
    ];
    const CRUCIAL_DATES = [
      new Date(2025, 0, 9),
      new Date(2025, 0, 12),
      new Date(2025, 0, 23),
      new Date(2025, 0, 28),
      new Date(2024, 4, 1),
      new Date(2025, 0, 29),
      new Date(2024, 11, 25)
    ];
    const EMOJI_DATES = {
      '2025-01-27': 'fire',
      '2025-01-28': 'boom',
      '2025-01-29': 'beer'
    };
    const START_DATE = new Date(2021, 0, 28);
    const LOCALSTORAGE_KEY = 'cycleSettingsAdv';
    const defaultSettings = {
      audioMuted: false,
      debugOverlay: false,
      fractalDetails: true,
      language: 'en'
    };
    // Key and Fibonacci cycles
    const FIBONACCI_CYCLES = [21, 34, 55, 89, 144, 233, 377, 610, 987, 1597];
    const KEY_CYCLES = [1461, 1470, 1471, 741, 147];
    function isKeyOrFibonacci(n) {
      return KEY_CYCLES.includes(n) || FIBONACCI_CYCLES.includes(n);
    }
    // Timeline key dates for extra narrative tooltips
    const KEY_DATES = {
      "2025-01-27": "RC moves 36M shares personally",
      "2025-01-29": "Catalyst: T+35 liquidation clock starts",
      "2025-02-10": "Possible mirror event (2:10 clock theory)",
      "2025-03-05": "T+35 from 1/29 ‚Äì potential forced covering event"
    };
    /************************************
     * 2) MINIMAL i18n (English Only)
     ************************************/
    const MESSAGES = {
      en: {
        muteAudioLabel: "Mute Audio",
        showDebugLabel: "Show Debug",
        showFractalLabel: "Show Fractals"
      }
    };
    function initI18n() { applyLanguage('en'); }
    function applyLanguage(lang) {
      const dict = MESSAGES[lang] || MESSAGES.en;
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) { el.textContent = dict[key]; }
      });
    }
    /************************************
     * 3) AUDIO
     ************************************/
    let audioCtx;
    function initAudioContext() {
      const AudioContext = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AudioContext();
      document.addEventListener('click', resumeAudioContext);
      document.addEventListener('touchstart', resumeAudioContext);
    }
    function resumeAudioContext() {
      if (audioCtx.state === 'suspended') { audioCtx.resume(); }
      document.removeEventListener('click', resumeAudioContext);
      document.removeEventListener('touchstart', resumeAudioContext);
    }
    function audioContextTime() { return audioCtx ? audioCtx.currentTime : performance.now() / 1000; }
    function scheduleTone(frequency, startTime, duration = 0.5) {
      if (settings.audioMuted) return;
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();
      oscillator.frequency.setValueAtTime(frequency, startTime);
      oscillator.type = 'sine';
      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);
      oscillator.start(startTime);
      gainNode.gain.setValueAtTime(0.3, startTime);
      gainNode.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
      oscillator.stop(startTime + duration);
    }
    function playPolyrhythm(frequencies, baseDuration = 0.5) {
      if (settings.audioMuted) return;
      const now = audioCtx.currentTime;
      frequencies.forEach((freq, index) => {
        scheduleTone(freq, now + index * 0.15, baseDuration);
      });
    }
    /************************************
     * 4) DRAWING UTILS
     ************************************/
    function drawCycleRing(ctx, x, y, radius, progress, color) {
      const angle = progress * 2 * Math.PI;
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.stroke();
      const markerX = x + Math.cos(angle) * radius;
      const markerY = y + Math.sin(angle) * radius;
      ctx.beginPath();
      ctx.arc(markerX, markerY, 6, 0, 2 * Math.PI);
      ctx.fillStyle = '#fff';
      ctx.fill();
    }
    function drawFractal(ctx, x, y, radius, depth, active) {
      if (!active || depth === 0) return;
      ctx.beginPath();
      ctx.arc(x, y, radius, 0, 2 * Math.PI);
      ctx.strokeStyle = 'rgba(255,215,0,0.5)';
      ctx.lineWidth = 2;
      ctx.stroke();
      const newRadius = radius * 0.5;
      for (let i = 0; i < 3; i++) {
        const angle = (i / 3) * 2 * Math.PI;
        const childX = x + newRadius * Math.cos(angle);
        const childY = y + newRadius * Math.sin(angle);
        drawFractal(ctx, childX, childY, newRadius, depth - 1, active);
      }
    }
    function showTooltip(tooltipEl, message, x, y) {
      tooltipEl.textContent = message;
      tooltipEl.style.left = (x + 10) + 'px';
      tooltipEl.style.top = (y + 10) + 'px';
      tooltipEl.style.display = 'block';
      setTimeout(() => { tooltipEl.style.display = 'none'; }, 2000);
    }
    function formatDate(date) {
      return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    function getCurrentDate(time) { return new Date(START_DATE.getTime() + time * 86400000); }
    /************************************
     * 5) MAIN LOGIC & LEGEND HIGHLIGHTING
     ************************************/
    let canvas, ctx;
    let time = 0;
    let isPaused = false;
    let isScrubbing = false;
    let scrubStartX = 0;
    let speedMultiplier = 0.05;
    let frameCount = 0;
    let lastDebugTime = performance.now();
    let triggeredResonances = new Set();
    let waves = [];
    function highlightLegend(cycleIdentifier) {
      const legendItem = document.querySelector(`.legend li[data-cycle="${cycleIdentifier}"]`);
      if (legendItem) {
        legendItem.classList.add('active');
        setTimeout(() => { legendItem.classList.remove('active'); }, 500);
      }
    }
    // If the current date matches one of our key timeline dates, show extra narrative.
    function checkKeyDates(currentDate, tooltipEl, x, y) {
      const iso = currentDate.toISOString().split('T')[0];
      if (KEY_DATES[iso]) {
        showTooltip(tooltipEl, KEY_DATES[iso], x, y);
      }
    }
    function loadSettings() { return Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '{}')); }
    const settings = loadSettings();
    function saveSettings() { localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(settings)); }
    /************************************
     * 6) RESONANCE & EVENT CHECKS
     ************************************/
    // Any alignment that meets the threshold triggers a resonance.
    // For near-crucial alignments, we play a fuller polyrhythm; otherwise, we use a deep 80 Hz thump
    // with extended haptic feedback (100 ms).
    function checkResonance(ctx, x, y, radius, progressA, progressB, currentDate, tooltipEl, cycleA, cycleB) {
      const alignmentThreshold = 0.02;
      const diff = Math.abs(progressA - progressB);
      const isAlignment = diff < alignmentThreshold || Math.abs(1 - diff) < alignmentThreshold;
      if (!isAlignment) return;
      const eventKey = `Res-${currentDate.toDateString()}-${radius}-${cycleA.name}-${cycleB.name}`;
      if (triggeredResonances.has(eventKey)) return;
      triggeredResonances.add(eventKey);
      // Check if alignment is near a crucial date:
      const dayThreshold = 1;
      const nearCrucial = CRUCIAL_DATES.some(cd => Math.abs((currentDate - cd) / 86400000) < dayThreshold);
      // Use the associated cycle's color for the resonance ring:
      const cycleColor = getComputedStyle(document.documentElement).getPropertyValue(cycleA.colorVar).trim();
      ctx.beginPath();
      ctx.arc(x, y, radius * 1.1, 0, 2 * Math.PI);
      ctx.strokeStyle = cycleColor;
      ctx.lineWidth = 4;
      ctx.stroke();
      drawFractal(ctx, x, y, radius * 1.1, 1, settings.fractalDetails);
      // Audio & Haptic Feedback:
      if (nearCrucial) {
        playPolyrhythm([261.63, 329.63, 392.0], 0.75);
        showTooltip(tooltipEl, `Resonance (Crucial):\n${cycleA.name} & ${cycleB.name}\non ${formatDate(currentDate)}`, x, y);
      } else {
        scheduleTone(80, audioContextTime() + 0.1, 0.5);
        if (navigator.vibrate) { navigator.vibrate(100); }
        showTooltip(tooltipEl, `Resonance:\n${cycleA.name} & ${cycleB.name}`, x, y);
      }
      spawnWave(x, y, radius * 1.1);
      if (isKeyOrFibonacci(cycleA.length)) { highlightLegend(cycleA.length); }
      if (isKeyOrFibonacci(cycleB.length)) { highlightLegend(cycleB.length); }
      // Check for additional narrative key dates:
      checkKeyDates(currentDate, tooltipEl, x, y);
    }
    function checkCrucialDates(ctx, x, y, currentDate, tooltipEl) {
      const dayThreshold = 1;
      const found = CRUCIAL_DATES.some(cd => Math.abs((currentDate - cd)/86400000) < dayThreshold);
      if (found) {
        const eventKey = `Crucial-${currentDate.toDateString()}`;
        if (!triggeredResonances.has(eventKey)) {
          triggeredResonances.add(eventKey);
          ctx.beginPath();
          ctx.arc(x, y, 150, 0, 2 * Math.PI);
          ctx.strokeStyle = 'rgba(255,165,0,0.8)';
          ctx.lineWidth = 4;
          ctx.stroke();
          scheduleTone(523.25, audioContextTime() + 0.1, 0.6);
          showTooltip(tooltipEl, `Crucial Date near\n${formatDate(currentDate)}`, x, y);
          spawnWave(x, y, 150);
        }
      }
    }
    function checkEmojiEvents(currentDate) {
      const formattedDate = currentDate.toISOString().split('T')[0];
      document.querySelector('.emoji.fire')
        .classList.toggle('active', EMOJI_DATES[formattedDate] === 'fire');
      document.querySelector('.emoji.boom')
        .classList.toggle('active', EMOJI_DATES[formattedDate] === 'boom');
      document.querySelector('.emoji.beer')
        .classList.toggle('active', EMOJI_DATES[formattedDate] === 'beer');
    }
    function spawnWave(x, y, startRadius = 0) {
      waves.push({ x, y, radius: startRadius, maxRadius: startRadius + 200, alpha: 1 });
    }
    function updateWaves() {
      for (let i = waves.length - 1; i >= 0; i--) {
        const w = waves[i];
        w.radius += 2;
        w.alpha -= 0.015;
        ctx.save();
        ctx.beginPath();
        ctx.arc(w.x, w.y, w.radius, 0, 2 * Math.PI);
        ctx.strokeStyle = `rgba(255,255,255,${w.alpha})`;
        ctx.lineWidth = 3;
        ctx.stroke();
        ctx.restore();
        if (w.radius >= w.maxRadius || w.alpha <= 0) { waves.splice(i, 1); }
      }
    }
    /************************************
     * 7) MAIN ANIMATION & EVENT HANDLERS
     ************************************/
    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.resetTransform();
      ctx.scale(dpr, dpr);
    }
    function drawAllCycles(ctx, tooltipEl, dateDisplay) {
      const rect = canvas.getBoundingClientRect();
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const ringSpacing = Math.min(rect.width, rect.height) / (2 * CYCLES.length);
      const currentDate = getCurrentDate(time);
      dateDisplay.textContent = `Current: ${formatDate(currentDate)}`;
      let cycleProgresses = [];
      CYCLES.forEach((cycle, idx) => {
        const progress = (time % cycle.length) / cycle.length;
        cycleProgresses.push(progress);
        const ringRadius = ringSpacing * (CYCLES.length - idx);
        const color = getComputedStyle(document.documentElement)
                      .getPropertyValue(cycle.colorVar)
                      .trim();
        drawCycleRing(ctx, centerX, centerY, ringRadius, progress, color);
      });
      for (let i = 0; i < CYCLES.length; i++) {
        for (let j = i + 1; j < CYCLES.length; j++) {
          const cycleA = CYCLES[i];
          const cycleB = CYCLES[j];
          if (!isKeyOrFibonacci(cycleA.length) && !isKeyOrFibonacci(cycleB.length)) continue;
          const ringRadius = ringSpacing * (CYCLES.length - i);
          checkResonance(ctx, centerX, centerY, ringRadius,
            cycleProgresses[i], cycleProgresses[j],
            currentDate, tooltipEl, cycleA, cycleB);
        }
      }
      checkCrucialDates(ctx, centerX, centerY, currentDate, tooltipEl);
      checkEmojiEvents(currentDate);
    }
    function animate(dateDisplay, tooltipEl, debugOverlay) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawAllCycles(ctx, tooltipEl, dateDisplay);
      updateWaves();
      frameCount++;
      const now = performance.now();
      if (now - lastDebugTime >= 1000) {
        if (settings.debugOverlay) {
          const currentDate = getCurrentDate(time);
          debugOverlay.textContent = `FPS: ${frameCount} | Time: ${time.toFixed(2)} | Date: ${formatDate(currentDate)}`;
        }
        frameCount = 0;
        lastDebugTime = now;
      }
      if (!isPaused && !isScrubbing) { time += speedMultiplier; }
      requestAnimationFrame(() => animate(dateDisplay, tooltipEl, debugOverlay));
    }
    function togglePause() {
      isPaused = !isPaused;
      document.getElementById('pause-btn').textContent = isPaused ? 'Play' : 'Pause';
    }
    function resetTime() { time = 0; triggeredResonances.clear(); waves = []; }
    function speedDown() { speedMultiplier = Math.max(speedMultiplier / 2, 0.01); }
    function speedUp() { speedMultiplier = Math.min(speedMultiplier * 2, 16); }
    function onWheelScrub(e) {
      e.preventDefault();
      const baseSensitivity = 0.0005;
      const acceleration = Math.log(Math.abs(e.deltaY) + 1);
      time += e.deltaY * baseSensitivity * acceleration;
    }
    function onTouchStart(e) { isScrubbing = true; scrubStartX = e.touches[0].clientX; }
    function onTouchMove(e) {
      if (!isScrubbing) return;
      const currentX = e.touches[0].clientX;
      time += (currentX - scrubStartX) / 5;
      scrubStartX = currentX;
    }
    function onTouchEnd() { isScrubbing = false; }
    /************************************
     * 8) INITIALIZATION
     ************************************/
    function startVisualization() {
      canvas = document.getElementById('cycleCanvas');
      ctx = canvas.getContext('2d');
      const pauseBtn      = document.getElementById('pause-btn');
      const resetBtn      = document.getElementById('reset-btn');
      const speedDownBtn  = document.getElementById('speed-down-btn');
      const speedUpBtn    = document.getElementById('speed-up-btn');
      const dateDisplay   = document.getElementById('date-display');
      const toggleMute    = document.getElementById('toggleMute');
      const toggleDebug   = document.getElementById('toggleDebug');
      const toggleFractal = document.getElementById('toggleFractal');
      const debugOverlay  = document.getElementById('debugOverlay');
      const tooltipEl     = document.getElementById('tooltip');
      const logo          = document.getElementById('custom-logo');
      toggleMute.checked = settings.audioMuted;
      toggleDebug.checked = settings.debugOverlay;
      toggleFractal.checked = settings.fractalDetails;
      debugOverlay.style.display = settings.debugOverlay ? 'block' : 'none';
      toggleMute.addEventListener('change', (e) => { settings.audioMuted = e.target.checked; saveSettings(); });
      toggleDebug.addEventListener('change', (e) => { settings.debugOverlay = e.target.checked; debugOverlay.style.display = settings.debugOverlay ? 'block' : 'none'; saveSettings(); });
      toggleFractal.addEventListener('change', (e) => { settings.fractalDetails = e.target.checked; saveSettings(); });
      pauseBtn.addEventListener('click', togglePause);
      resetBtn.addEventListener('click', resetTime);
      speedDownBtn.addEventListener('click', speedDown);
      speedUpBtn.addEventListener('click', speedUp);
      document.addEventListener('keydown', (e) => {
        switch(e.key) {
          case ' ':
            e.preventDefault();
            togglePause();
            break;
          case 'r':
          case 'R':
            resetTime();
            break;
          case 'ArrowUp':
            speedUp();
            break;
          case 'ArrowDown':
            speedDown();
            break;
        }
      });
      canvas.addEventListener('wheel', onWheelScrub, { passive: false });
      canvas.addEventListener('touchstart', onTouchStart);
      canvas.addEventListener('touchmove', onTouchMove);
      canvas.addEventListener('touchend', onTouchEnd);
      logo.addEventListener('load', () => { logo.classList.add('loaded'); });
      window.addEventListener('resize', () => {
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(resizeCanvas, 200);
      });
      resizeCanvas();
      animate(dateDisplay, tooltipEl, debugOverlay);
    }
    /************************************
     * 9) INIT CALLS
     ************************************/
    initConfig();
    initI18n();
    initAudioContext();
    startVisualization();
  </script>
</body>
</html>
