<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="Cycle Resonance Visualization – Dune Thumper Edition" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cycle Resonance Visualization – Dune Thumper Edition</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dune-inspired colors */
      --bg-color: #0B0B0B;              /* Nearly pitch-black */
      --text-color: #EAE1CF;            /* Warm, creamy off-white */
      --panel-bg: rgba(30,25,20,0.95);   /* Rich, saturated earthy brown */
      --highlight: #C5000B;             /* Vivid red accent */
      
      /* Cycle Colors (GameStop accents) */
      --keymaster:   #C5000B;  /* 1471-day (Key master cycle) */
      --cycle741:    #8B0000;  /* 741-day */
      --cycle147:    #FFD200;  /* 147-day */
      --cycle110:    #4B3621;  /* 110-day */
      --cycle55:     #6E5843;  /* 55-day */
      --cycle35:     #C5000B;  /* 35-day */
      --cycle21:     #FFFFFF;  /* 21-day */
      --tplus1:      #C0C0C0;  /* T+1 */
      --tplus2:      #808080;  /* T+2 */
      
      /* Legend Dot Colors */
      --legend-1471: var(--keymaster);
      --legend-741:  var(--cycle741);
      --legend-147:  var(--cycle147);
      --legend-110:  var(--cycle110);
      --legend-55:   var(--cycle55);
      --legend-35:   var(--cycle35);
      --legend-21:   var(--cycle21);
      --legend-t1:   var(--tplus1);
      --legend-t2:   var(--tplus2);
    }
    
    /* Reset & Base Styling */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; }
    body {
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      transition: background 0.3s, color 0.3s;
    }
    
    /* Container */
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Canvas: fills the screen; disable default touch actions */
    #cycleCanvas {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      height: 100%;
      z-index: 1;
      touch-action: none;
    }
    
    /* Top Controls Panel */
    .controls {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 800px;
      background: var(--panel-bg);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 4px 16px rgba(0,0,0,0.5);
      z-index: 4;
      padding: 0.5rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
    }
    .control-buttons {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .controls button,
    .controls input[type="range"] {
      margin-right: 10px;
    }
    .controls label {
      font-size: 0.85rem;
      cursor: pointer;
    }
    /* Time Scrub Slider (0–5000 units) */
    #time-scrub { width: 300px; }
    /* Playback Speed Buttons */
    .speed-btns {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .speed-btn {
      padding: 4px 8px;
      font-size: 0.85rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: var(--highlight);
      color: var(--text-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .speed-btn.active { box-shadow: 0 0 12px var(--highlight); }
    .date-display {
      font-size: 0.9rem;
      color: rgba(240,234,214,0.9);
      white-space: nowrap;
      text-align: center;
    }
    
    /* Bottom Legend Panel */
    .legend {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 800px;
      background: var(--panel-bg);
      border-radius: 12px 12px 0 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      box-shadow: 0 -4px 16px rgba(0,0,0,0.5);
      z-index: 4;
      padding: 0.5rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .legend ul {
      display: flex;
      flex-wrap: wrap;
      list-style: none;
      gap: 15px;
      justify-content: center;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    .legend li {
      display: flex;
      align-items: center;
      gap: 5px;
      flex: 1 1 120px;
      justify-content: center;
      transition: background 0.3s, box-shadow 0.3s;
    }
    .legend li.active {
      background: rgba(255,255,255,0.2);
      box-shadow: 0 0 8px rgba(255,255,255,0.8);
    }
    .legend-dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    /* Legend Debug Info */
    #legend-debug {
      font-size: 0.75rem;
      text-align: center;
      margin-top: 5px;
      color: rgba(255,255,255,0.8);
    }
    
    /* Sound Wave Animation */
    .sound-wave {
      position: absolute;
      border: 2px solid var(--highlight);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: expand 1s linear infinite;
      opacity: 0.6;
      pointer-events: none;
      z-index: 5;
      display: none;
    }
    @keyframes expand {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.6; }
      100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }
    
    /* Tooltip */
    .tooltip {
      position: absolute;
      padding: 6px 10px;
      background: var(--panel-bg);
      color: var(--text-color);
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      pointer-events: none;
      z-index: 999;
      display: none;
      font-size: 0.8rem;
      white-space: pre-line;
    }
    
    /* Logo & Emoji – Logo fixed in upper left corner */
    .logo-container {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 6;
      display: flex;
      align-items: center;
    }
    #custom-logo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      transition: opacity 0.5s ease-in-out;
      opacity: 0;
      object-fit: cover;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #custom-logo.loaded { opacity: 1; }
    .emoji {
      position: absolute;
      top: -30px;
      font-size: 24px;
      transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      opacity: 0;
      pointer-events: none;
    }
    .emoji.active {
      opacity: 1;
      transform: translateY(-10px);
    }
    .emoji.fire { left: 50%; transform: translateX(-50%); }
    .emoji.boom { left: 60%; transform: translateX(-50%); }
    .emoji.beer { left: 40%; transform: translateX(-50%); }
    
    /* Responsive */
    @media (max-width: 768px) {
      .controls { width: 95%; top: 10px; }
      .legend { bottom: 0; }
      #custom-logo { width: 35px; height: 35px; }
      .emoji { font-size: 20px; }
    }
    @media (max-width: 480px) {
      .controls { flex-direction: column; gap: 8px; align-items: center; }
      .controls button { min-width: 70px; padding: 6px 12px; font-size: 0.8rem; }
      .date-display { font-size: 0.8rem; margin-top: 8px; }
      .legend { bottom: 0; padding: 0.5rem 0.75rem; gap: 10px; }
      .legend li { flex: 1 1 100px; }
      #custom-logo { width: 30px; height: 30px; }
      .emoji { font-size: 18px; }
    }
    @media (max-width: 320px) {
      .controls button { min-width: 60px; padding: 5px 8px; font-size: 0.7rem; }
      .date-display { font-size: 0.7rem; }
      .legend li { flex: 1 1 80px; }
      #custom-logo { width: 25px; height: 25px; }
      .emoji { font-size: 16px; }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Top Controls Panel -->
    <div class="controls" id="controls" role="region" aria-label="Animation Controls">
      <div class="control-buttons">
        <button id="pause-btn" aria-label="Pause/Play">Pause</button>
        <button id="reset-btn" aria-label="Reset Animation">Reset</button>
        <label>
          Time Scrub:
          <input type="range" id="time-scrub" min="0" max="5000" step="1" value="0">
        </label>
      </div>
      <div class="speed-btns">
        <button class="speed-btn" data-speed="0.03">1×</button>
        <button class="speed-btn" data-speed="0.06">2×</button>
        <button class="speed-btn" data-speed="0.18">6×</button>
        <button class="speed-btn" data-speed="0.24">8×</button>
      </div>
      <div class="date-display" id="date-display">Current: [Loading...]</div>
    </div>
    <!-- Bottom Legend Panel -->
    <div class="legend" id="legend" role="region" aria-label="Cycle Legend">
      <ul>
        <li data-cycle="1471-day"><span class="legend-dot" style="background: var(--keymaster);"></span> 1471-day Cycle</li>
        <li data-cycle="741-day"><span class="legend-dot" style="background: var(--cycle741);"></span> 741-day Cycle</li>
        <li data-cycle="147-day"><span class="legend-dot" style="background: var(--cycle147);"></span> 147-day Cycle</li>
        <li data-cycle="110-day"><span class="legend-dot" style="background: var(--cycle110);"></span> 110-day Cycle</li>
        <li data-cycle="55-day"><span class="legend-dot" style="background: var(--cycle55);"></span> 55-day Cycle</li>
        <li data-cycle="35-day"><span class="legend-dot" style="background: var(--cycle35);"></span> 35-day Cycle</li>
        <li data-cycle="21-day"><span class="legend-dot" style="background: var(--cycle21);"></span> 21-day Cycle</li>
        <li data-cycle="T+1"><span class="legend-dot" style="background: var(--tplus1);"></span> T+1</li>
        <li data-cycle="T+2"><span class="legend-dot" style="background: var(--tplus2);"></span> T+2</li>
      </ul>
      <div id="legend-debug">Debug Info: [N/A]</div>
    </div>
    <!-- Logo & Emoji Container -->
    <div class="logo-container">
      <a href="#" target="_blank" rel="noopener noreferrer">
        <img id="custom-logo" src="https://fibonacciai.github.io/42069/power-512.png" alt="Power Logo">
      </a>
      <span class="emoji fire" aria-hidden="true">🔥</span>
      <span class="emoji boom" aria-hidden="true">💥</span>
      <span class="emoji beer" aria-hidden="true">🍻</span>
    </div>
    <!-- Canvas -->
    <canvas id="cycleCanvas">Your browser does not support the canvas element.</canvas>
  </div>
  <!-- Sound Wave Element -->
  <div class="sound-wave" id="soundWave"></div>
  <!-- Tooltip -->
  <div id="tooltip" class="tooltip" role="tooltip"></div>
  
  <script>
    // Global variables for multitouch.
    let currentScale = 1;
    let panOffset = { x: 0, y: 0 };
    let initialDistance = 0;
    let initialScale = 1;
    let initialPan = {};

    function getDistance(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }
    
    // --------------------- Begin Initialization ---------------------
    window.addEventListener('load', function() {
      
      /*************** 1) CONFIG & INITIAL DATA ***************/
      function initConfig() { }
      const CYCLES = [
        { name: '1471-day', length: 1471, colorVar: '--keymaster' },
        { name: '741-day',  length: 741,  colorVar: '--cycle741' },
        { name: '147-day',  length: 147,  colorVar: '--cycle147' },
        { name: '110-day',  length: 110,  colorVar: '--cycle110' },
        { name: '55-day',   length: 55,   colorVar: '--cycle55' },
        { name: '35-day',   length: 35,   colorVar: '--cycle35' },
        { name: '21-day',   length: 21,   colorVar: '--cycle21' },
        { name: 'T+1',      length: 1,    colorVar: '--tplus1' },
        { name: 'T+2',      length: 2,    colorVar: '--tplus2' }
      ];
      const KEY_DATES = {
        "2021-01-28": "MOASS Origin – the buy button was turned off.",
        "2023-12-05": "Time Magazine Meme Drop – shorting becomes perilous 🔥",
        "2023-12-25": "Gift Box Meme – the trap is set 💥",
        "2025-01-28": "35-Day Squeeze Anniversary – pressure peaks.",
        "2025-01-29": "Lunar New Year & Epic Culmination – the thumper roars 🍻"
      };
      const CRUCIAL_DATES = [
        new Date(2021, 0, 28),
        new Date(2023, 11, 5),
        new Date(2023, 11, 25),
        new Date(2025, 0, 28),
        new Date(2025, 0, 29)
      ];
      const EMOJI_DATES = {
        "2021-01-28": "🔥",
        "2023-12-05": "🔥",
        "2023-12-25": "💥",
        "2025-01-29": "🍻"
      };
      const START_DATE = new Date(2021, 0, 28);
      const LOCALSTORAGE_KEY = 'cycleSettingsAdv';
      const defaultSettings = {
        audioMuted: false,
        debugOverlay: false,
        fractalDetails: true,
        language: 'en'
      };
      const FIBONACCI_CYCLES = [21, 34, 55, 89, 144, 233, 377, 610, 987, 1597];
      const KEY_CYCLES = [1471, 741, 147, 110, 55, 35, 21];
      function isKeyOrFibonacci(n) {
        return KEY_CYCLES.includes(n) || FIBONACCI_CYCLES.includes(n);
      }
      
      /*************** 2) MINIMAL i18n ***************/
      const MESSAGES = {
        en: {
          muteAudioLabel: "Mute Audio",
          showDebugLabel: "Show Debug",
          showFractalLabel: "Show Harmonics"
        }
      };
      function initI18n() { applyLanguage('en'); }
      function applyLanguage(lang) {
        const dict = MESSAGES[lang] || MESSAGES.en;
        document.querySelectorAll('[data-i18n]').forEach(el => {
          const key = el.getAttribute('data-i18n');
          if (dict[key]) { el.textContent = dict[key]; }
        });
      }
      
      /*************** 3) AUDIO SETUP ***************/
      let audioCtx;
      function initAudioContext() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
        document.addEventListener('click', resumeAudioContext);
        document.addEventListener('touchstart', resumeAudioContext);
      }
      function resumeAudioContext() {
        if (audioCtx.state === 'suspended') { audioCtx.resume(); }
        document.removeEventListener('click', resumeAudioContext);
        document.removeEventListener('touchstart', resumeAudioContext);
      }
      function audioContextTime() { return audioCtx ? audioCtx.currentTime : performance.now() / 1000; }
      // playThumper uses 35 Hz, 1.5 sec duration, and a higher initial gain (0.5) for a deeper, smoother thump.
      function playThumper() {
        scheduleTone(35, audioContextTime(), 1.5, "sine", 0.5);
      }
      // scheduleTone now accepts an optional initialGain parameter.
      function scheduleTone(frequency, startTime, duration = 0.5, type = "sine", initialGain = 0.3) {
        if (settings.audioMuted) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.frequency.setValueAtTime(frequency, startTime);
        oscillator.type = type;
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.start(startTime);
        gainNode.gain.setValueAtTime(initialGain, startTime);
        gainNode.gain.exponentialRampToValueAtTime(0.0001, startTime + duration);
        oscillator.stop(startTime + duration);
      }
      function playPolyrhythm(frequencies, baseDuration = 0.5) {
        if (settings.audioMuted) return;
        const now = audioCtx.currentTime;
        frequencies.forEach((freq, index) => {
          scheduleTone(freq, now + index * 0.15, baseDuration);
        });
      }
      
      /*************** 4) DRAWING & HARMONIC OVERLAY ***************/
      function drawCycleRing(ctx, x, y, radius, progress, color) {
        const angle = progress * 2 * Math.PI;
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, 2 * Math.PI);
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();
        const markerX = x + Math.cos(angle) * radius;
        const markerY = y + Math.sin(angle) * radius;
        ctx.beginPath();
        ctx.arc(markerX, markerY, 6, 0, 2 * Math.PI);
        ctx.fillStyle = '#fff';
        ctx.fill();
      }
      function drawHarmonicOverlay(ctx, x, y, baseRadius, color) {
        const numArcs = 5;
        for (let i = 0; i < numArcs; i++) {
          const radius = baseRadius * (1 + i * 0.05);
          const opacity = 1 - i * (1 / numArcs);
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, 2 * Math.PI);
          ctx.strokeStyle = hexToRGBA(color, opacity);
          ctx.lineWidth = 2;
          ctx.stroke();
        }
      }
      function hexToRGBA(color, alpha) {
        if (color.indexOf("rgb(") === 0) {
          return color.replace(")", `, ${alpha})`).replace("rgb", "rgba");
        }
        if (color[0] === "#") { color = color.slice(1); }
        if (color.length === 3) { color = color.split('').map(c => c + c).join(''); }
        const r = parseInt(color.substring(0, 2), 16);
        const g = parseInt(color.substring(2, 4), 16);
        const b = parseInt(color.substring(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }
      function showTooltip(tooltipEl, message, x, y) {
        tooltipEl.textContent = message;
        tooltipEl.style.left = (x + 10) + 'px';
        tooltipEl.style.top = (y + 10) + 'px';
        tooltipEl.style.display = 'block';
        setTimeout(() => { tooltipEl.style.display = 'none'; }, 2000);
      }
      function formatDate(date) {
        return date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      }
      function getCurrentDate(time) { return new Date(START_DATE.getTime() + time * 86400000); }
      
      /*************** 5) MAIN LOGIC & LEGEND HIGHLIGHTING ***************/
      let time = 0;
      let isPaused = false;
      let isScrubbing = false;
      let scrubStartX = 0;
      let speedMultiplier = 0.03; // Default 1× playback speed.
      let frameCount = 0;
      let lastDebugTime = performance.now();
      let triggeredResonances = new Set();
      let waves = [];
      
      // Time scrub slider listeners.
      const timeScrubSlider = document.getElementById("time-scrub");
      if (timeScrubSlider) {
        timeScrubSlider.addEventListener("input", (e) => {
          isScrubbing = true;
          time = parseFloat(e.target.value);
        });
        timeScrubSlider.addEventListener("change", (e) => {
          isScrubbing = false;
        });
      }
      function highlightLegend(cycleIdentifier) {
        const legendItem = document.querySelector(`.legend li[data-cycle="${cycleIdentifier}"]`);
        if (legendItem) {
          legendItem.classList.add('active');
          setTimeout(() => { legendItem.classList.remove('active'); }, 500);
        }
      }
      function checkKeyDates(currentDate, tooltipEl, x, y) {
        const iso = currentDate.toISOString().split('T')[0];
        if (KEY_DATES[iso]) {
          showTooltip(tooltipEl, KEY_DATES[iso], x, y);
        }
      }
      const settings = (function loadSettings(){
        return Object.assign({}, defaultSettings, JSON.parse(localStorage.getItem(LOCALSTORAGE_KEY) || '{}'));
      })();
      function saveSettings() { localStorage.setItem(LOCALSTORAGE_KEY, JSON.stringify(settings)); }
      
      /*************** 6) RESONANCE & EVENT CHECKS ***************/
      function checkResonance(ctx, x, y, radius, progressA, progressB, currentDate, tooltipEl, cycleA, cycleB) {
        const alignmentThreshold = 0.02;
        const diff = Math.abs(progressA - progressB);
        const isAlignment = diff < alignmentThreshold || Math.abs(1 - diff) < alignmentThreshold;
        if (!isAlignment) return;
        const eventKey = `Res-${currentDate.toDateString()}-${radius}-${cycleA.name}-${cycleB.name}`;
        if (triggeredResonances.has(eventKey)) return;
        triggeredResonances.add(eventKey);
        const dayThreshold = 1;
        const nearCrucial = CRUCIAL_DATES.some(cd => Math.abs((currentDate - cd) / 86400000) < dayThreshold);
        const cycleColor = getComputedStyle(document.documentElement).getPropertyValue(cycleA.colorVar).trim();
        ctx.beginPath();
        ctx.arc(x, y, radius * 1.1, 0, 2 * Math.PI);
        // Increase stroke width for near-crucial events.
        ctx.lineWidth = nearCrucial ? 6 : 4;
        ctx.strokeStyle = cycleColor;
        ctx.stroke();
        drawHarmonicOverlay(ctx, x, y, radius * 1.1, cycleColor);
        if (nearCrucial) {
          playPolyrhythm([261.63, 329.63, 392.0], 0.75);
          playThumper();
          showTooltip(tooltipEl, `Resonance (Crucial):\n${cycleA.name} & ${cycleB.name}\non ${formatDate(currentDate)}`, x, y);
        } else {
          // Adjusted mid-range tone: smoother decay and lower gain.
          scheduleTone(80, audioContextTime() + 0.1, 0.75, "sine", 0.2);
          if (navigator.vibrate) { navigator.vibrate(100); }
          showTooltip(tooltipEl, `Resonance:\n${cycleA.name} & ${cycleB.name}`, x, y);
        }
        spawnWave(x, y, radius * 1.1);
        if (isKeyOrFibonacci(cycleA.length)) { highlightLegend(cycleA.name); }
        if (isKeyOrFibonacci(cycleB.length)) { highlightLegend(cycleB.name); }
        checkKeyDates(currentDate, tooltipEl, x, y);
      }
      function checkCrucialDates(ctx, x, y, currentDate, tooltipEl) {
        const dayThreshold = 1;
        const found = CRUCIAL_DATES.some(cd => Math.abs((currentDate - cd) / 86400000) < dayThreshold);
        if (found) {
          const eventKey = `Crucial-${currentDate.toDateString()}`;
          if (!triggeredResonances.has(eventKey)) {
            triggeredResonances.add(eventKey);
            ctx.beginPath();
            ctx.arc(x, y, 150, 0, 2 * Math.PI);
            ctx.strokeStyle = 'rgba(255,165,0,0.8)';
            ctx.lineWidth = 4;
            ctx.stroke();
            scheduleTone(523.25, audioContextTime() + 0.1, 0.6);
            showTooltip(tooltipEl, `Crucial Date near\n${formatDate(currentDate)}`, x, y);
            spawnWave(x, y, 150);
          }
        }
      }
      function checkEmojiEvents(currentDate) {
        const formattedDate = currentDate.toISOString().split('T')[0];
        document.querySelector('.emoji.fire').classList.toggle('active', EMOJI_DATES[formattedDate] === '🔥');
        document.querySelector('.emoji.boom').classList.toggle('active', EMOJI_DATES[formattedDate] === '💥');
        document.querySelector('.emoji.beer').classList.toggle('active', EMOJI_DATES[formattedDate] === '🍻');
      }
      function spawnWave(x, y, startRadius = 0) {
        waves.push({ x, y, radius: startRadius, maxRadius: startRadius + 250, alpha: 1 });
      }
      function updateWaves() {
        for (let i = waves.length - 1; i >= 0; i--) {
          const w = waves[i];
          w.radius += 2;
          w.alpha -= 0.015;
          ctx.save();
          ctx.beginPath();
          ctx.arc(w.x, w.y, w.radius, 0, 2 * Math.PI);
          ctx.strokeStyle = `rgba(255,255,255,${w.alpha})`;
          ctx.lineWidth = 3;
          ctx.stroke();
          ctx.restore();
          if (w.radius >= w.maxRadius || w.alpha <= 0) { waves.splice(i, 1); }
        }
      }
      
      /*************** 7) MAIN ANIMATION & EVENT HANDLERS ***************/
      function resizeCanvas() {
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.resetTransform();
        ctx.scale(dpr, dpr);
      }
      
      // Multitouch: Pinch-to-Zoom and Pan.
      let currentScale = 1;
      let panOffset = { x: 0, y: 0 };
      let initialDistance = 0;
      let initialScale = 1;
      let initialPan = {};
      function getDistance(touches) {
        const dx = touches[0].clientX - touches[1].clientX;
        const dy = touches[0].clientY - touches[1].clientY;
        return Math.sqrt(dx * dx + dy * dy);
      }
      
      canvas.addEventListener("touchmove", (e) => {
        if (!e.touches) return;
        if (e.touches.length >= 2) {
          // Two-finger pinch-to-zoom
          const newDistance = getDistance(e.touches);
          if (initialDistance === 0) {
            initialDistance = newDistance;
            initialScale = currentScale;
          } else {
            const scaleFactor = newDistance / initialDistance;
            currentScale = initialScale * scaleFactor;
            currentScale = Math.max(0.5, Math.min(currentScale, 5));
          }
          e.preventDefault();
        } else if (e.touches.length === 1) {
          // One-finger pan
          const touch = e.touches[0];
          if (initialPan.x === undefined) {
            initialPan = { x: touch.clientX, y: touch.clientY };
          } else {
            const dx = touch.clientX - initialPan.x;
            const dy = touch.clientY - initialPan.y;
            panOffset.x += dx;
            panOffset.y += dy;
            initialPan = { x: touch.clientX, y: touch.clientY };
          }
          e.preventDefault();
        }
      });
      canvas.addEventListener("touchend", (e) => {
        if (e.touches.length < 2) {
          initialDistance = 0;
          initialPan = {};
        }
      });
      let lastTap = 0;
      canvas.addEventListener("touchend", (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0) {
          // Double-tap detected: reset zoom and pan.
          currentScale = 1;
          panOffset = { x: 0, y: 0 };
        }
        lastTap = currentTime;
      });
      
      // Draw cycles with pan and zoom applied.
      function drawAllCycles(ctx, tooltipEl, dateDisplay) {
        const rect = canvas.getBoundingClientRect();
        ctx.save();
        ctx.translate(panOffset.x, panOffset.y);
        ctx.scale(currentScale, currentScale);
        const centerX = rect.width / (2 * currentScale);
        const centerY = rect.height / (2 * currentScale);
        const ringSpacing = Math.min(rect.width, rect.height) / (2 * CYCLES.length * currentScale);
        const currentDate = getCurrentDate(time);
        dateDisplay.textContent = `Current: ${formatDate(currentDate)}`;
        let cycleProgresses = [];
        CYCLES.forEach((cycle, idx) => {
          const progress = (time % cycle.length) / cycle.length;
          cycleProgresses.push(progress);
          const ringRadius = ringSpacing * (CYCLES.length - idx);
          const color = getComputedStyle(document.documentElement)
                        .getPropertyValue(cycle.colorVar)
                        .trim();
          drawCycleRing(ctx, centerX, centerY, ringRadius, progress, color);
          if (settings.fractalDetails) {
            drawHarmonicOverlay(ctx, centerX, centerY, ringRadius, color);
          }
        });
        for (let i = 0; i < CYCLES.length; i++) {
          for (let j = i + 1; j < CYCLES.length; j++) {
            const cycleA = CYCLES[i];
            const cycleB = CYCLES[j];
            if (!isKeyOrFibonacci(cycleA.length) && !isKeyOrFibonacci(cycleB.length)) continue;
            const ringRadius = ringSpacing * (CYCLES.length - i);
            checkResonance(ctx, centerX, centerY, ringRadius,
              cycleProgresses[i], cycleProgresses[j],
              currentDate, tooltipEl, cycleA, cycleB);
          }
        }
        checkCrucialDates(ctx, centerX, centerY, currentDate, tooltipEl);
        checkEmojiEvents(currentDate);
        ctx.restore();
        document.getElementById('legend-debug').textContent = `Time: ${time.toFixed(2)} | FPS: ${frameCount}`;
      }
      function animate(dateDisplay, tooltipEl) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawAllCycles(ctx, tooltipEl, dateDisplay);
        updateWaves();
        frameCount++;
        const now = performance.now();
        if (now - lastDebugTime >= 1000) {
          frameCount = 0;
          lastDebugTime = now;
        }
        if (!isPaused && !isScrubbing) { 
          time += speedMultiplier;
        }
        requestAnimationFrame(() => animate(dateDisplay, tooltipEl));
      }
      function togglePause() {
        isPaused = !isPaused;
        document.getElementById('pause-btn').textContent = isPaused ? 'Play' : 'Pause';
      }
      function resetTime() { time = 0; triggeredResonances.clear(); waves = []; }
      function onWheelScrub(e) {
        e.preventDefault();
        const baseSensitivity = 0.0005;
        const acceleration = Math.log(Math.abs(e.deltaY) + 1);
        time += e.deltaY * baseSensitivity * acceleration;
      }
      function onTouchStart(e) { isScrubbing = true; scrubStartX = e.touches[0].clientX; }
      function onTouchMove(e) {
        if (!isScrubbing) return;
        const currentX = e.touches[0].clientX;
        time += (currentX - scrubStartX) / 5;
        scrubStartX = currentX;
      }
      function onTouchEnd() { isScrubbing = false; }
      
      /*************** 8) PLAYBACK SPEED CONTROL ***************/
      function initSpeedButtons() {
        const speedButtons = document.querySelectorAll(".speed-btn");
        speedButtons.forEach(btn => {
          btn.addEventListener("click", (e) => {
            speedMultiplier = parseFloat(e.target.getAttribute("data-speed"));
            speedButtons.forEach(b => b.classList.remove("active"));
            e.target.classList.add("active");
          });
        });
      }
      
      /*************** 9) INITIALIZATION ***************/
      function startVisualization() {
        canvas = document.getElementById('cycleCanvas');
        ctx = canvas.getContext('2d');
        const pauseBtn = document.getElementById('pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        const dateDisplay = document.getElementById('date-display');
        const tooltipEl = document.getElementById('tooltip');
        const logo = document.getElementById('custom-logo');
        
        pauseBtn.addEventListener('click', togglePause);
        resetBtn.addEventListener('click', resetTime);
        document.addEventListener('keydown', (e) => {
          if (e.key === ' ') { e.preventDefault(); togglePause(); }
          else if (e.key.toLowerCase() === 'r') { resetTime(); }
        });
        canvas.addEventListener('wheel', onWheelScrub, { passive: false });
        canvas.addEventListener('touchstart', onTouchStart);
        canvas.addEventListener('touchmove', onTouchMove);
        canvas.addEventListener('touchend', onTouchEnd);
        logo.addEventListener('load', () => { logo.classList.add('loaded'); });
        window.addEventListener('resize', () => {
          clearTimeout(window.resizeTimeout);
          window.resizeTimeout = setTimeout(resizeCanvas, 200);
        });
        resizeCanvas();
        initSpeedButtons();
        animate(dateDisplay, tooltipEl);
      }
      
      /*************** 10) INIT CALLS ***************/
      initConfig();
      initI18n();
      initAudioContext();
      startVisualization();
    });
  </script>
</body>
</html>
